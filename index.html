<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>엔터테인먼트 투자 요청서 (Pro Version)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #111827; }
    .validation-error { border-color: #f87171 !important; }
    .validation-message { color: #fca5a5; font-size: 0.8rem; }
    .alert { padding: 10px 18px; border-radius: 10px; margin-bottom: 18px;}
    .alert-success { background: #22c55e22; color: #22c55e; border:1.5px solid #22c55e;}
    .alert-error { background: #f43f5e22; color: #f43f5e; border:1.5px solid #f43f5e;}
    @media print {
      body { background-color: white; color: black; }
      .no-print { display: none; }
      .print-section { background: white !important; border: 1px solid #e5e7eb !important; box-shadow: none !important; color: black !important; }
      .print-text, .print-text * { color: black !important; }
      .print-input { border: 1px solid #d1d5db !important; -webkit-print-color-adjust: exact; }
    }
  </style>
</head>
<body class="text-gray-200 p-4 sm:p-8">
  <div class="max-w-4xl mx-auto">
    <header class="text-center mb-12 no-print">
      <h1 class="text-4xl sm:text-5xl font-bold text-white mb-3">Entertainment Investment Proposal</h1>
      <p class="text-lg text-gray-400">BEP/ROI 자동계산, 첨부파일 포함 이메일 제출, 실시간 요약, 차트까지 실전 투자 양식</p>
    </header>

    <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section">
      <h2 class="text-2xl font-bold text-white mb-6 pb-4 border-b border-gray-700 print-text">Project Summary (프로젝트 개요)</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center"><h3 class="text-sm font-medium text-gray-400 mb-2 print-text">총 투자 요청액</h3><p id="summary-investment" class="text-2xl lg:text-3xl font-bold text-indigo-400 print-text">₩0</p></div>
        <div class="text-center"><h3 class="text-sm font-medium text-gray-400 mb-2 print-text">총 예상 매출</h3><p id="summary-revenue" class="text-2xl lg:text-3xl font-bold text-green-400 print-text">₩0</p></div>
        <div class="text-center"><h3 class="text-sm font-medium text-gray-400 mb-2 print-text">예상 순수익</h3><p id="summary-profit" class="text-2xl lg:text-3xl font-bold text-green-400 print-text">₩0</p></div>
        <div class="text-center"><h3 class="text-sm font-medium text-gray-400 mb-2 print-text">예상 수익률 (ROI)</h3><p id="summary-roi" class="text-2xl lg:text-3xl font-bold text-green-400 print-text">0%</p></div>
      </div>
    </section>

    <form id="investment-form"
      action="https://formspree.io/f/xblynogp"
      method="POST"
      enctype="multipart/form-data"
      class="mb-8">

      <div id="alert-box"></div>

      <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section">
        <h2 class="text-2xl font-bold text-white mb-6 pb-4 border-b border-gray-700 print-text">1. 공연 정보</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
          <div>
            <label for="performance-name" class="block text-sm font-medium text-gray-300 mb-2 print-text">공연명 <span class="text-red-500">*</span></label>
            <input type="text" id="performance-name" name="performance_name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required>
          </div>
          <div>
            <label for="artist-name" class="block text-sm font-medium text-gray-300 mb-2 print-text">아티스트명 <span class="text-red-500">*</span></label>
            <input type="text" id="artist-name" name="artist_name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required>
          </div>
        </div>
      </section>
      
      <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section">
        <h2 class="text-2xl font-bold text-white mb-6 pb-4 border-b border-gray-700 print-text">2. 투자 조건 및 수익 분석</h2>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
          <div>
            <label for="investment-amount" class="block text-sm font-medium text-gray-300 mb-2 print-text">투자 요청 금액 <span class="text-red-500">*</span></label>
            <div class="flex">
              <input type="number" id="investment-amount" name="investment_amount" class="w-full bg-gray-700 border border-gray-600 rounded-l-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required>
              <select id="currency" class="bg-gray-600 border border-gray-600 rounded-r-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input"><option value="KRW">KRW</option><option value="USD">USD</option></select>
            </div>
            <p id="exchange-rate-info" class="text-sm text-gray-400 mt-2 print-text"></p>
          </div>
          <div>
            <label for="investment-period-start" class="block text-sm font-medium text-gray-300 mb-2 print-text">총 투자기간 <span class="text-red-500">*</span></label>
            <div class="flex items-center gap-2">
              <input type="date" id="investment-period-start" name="investment_period_start" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required> 
              <span class="print-text">~</span> 
              <input type="date" id="investment-period-end" name="investment_period_end" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required>
            </div>
            <div id="investment-period-error" class="validation-message mt-1"></div>
          </div>
          <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2 print-text">손익분기점 (BEP) 매출액</label>
              <input type="text" id="bep-amount-display" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-green-400 font-semibold print-input" readonly>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2 print-text">손익분기점 (BEP) 달성률</label>
              <input type="text" id="bep-rate-display" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-green-400 font-semibold print-input" readonly>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-700">
          <h2 class="text-2xl font-bold text-white print-text">3. 수익 계획</h2>
           <div class="flex gap-2 no-print">
              <button type="button" class="scenario-btn px-3 py-1 bg-red-800 hover:bg-red-700 text-white text-xs font-semibold rounded-md" data-rate="0.8">비관적 (-20%)</button>
              <button type="button" class="scenario-btn px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold rounded-md" data-rate="1.0">기본 (100%)</button>
              <button type="button" class="scenario-btn px-3 py-1 bg-green-800 hover:bg-green-700 text-white text-xs font-semibold rounded-md" data-rate="1.2">낙관적 (+20%)</button>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-4 text-gray-300 print-text">A. 티켓 판매</h3>
          <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-gray-700"><th class="p-4 text-sm font-medium text-gray-400 print-text">구분</th><th class="p-4 text-sm font-medium text-gray-400 print-text">티켓 종류</th><th class="p-4 text-sm font-medium text-gray-400 print-text">수량</th><th class="p-4 text-sm font-medium text-gray-400 print-text">금액 (원)</th><th class="p-4 text-sm font-medium text-gray-400 print-text">합계</th><th class="p-4"></th></tr></thead><tbody id="ticket-table-body"></tbody><tfoot><tr class="border-t-2 border-gray-700 font-bold"><td class="p-4 print-text" colspan="2">티켓 매출 합계</td><td class="p-4 print-text" id="total-quantity">0</td><td class="p-4"></td><td class="p-4 print-text" id="total-revenue">0 원</td><td></td></tr></tfoot></table></div>
          <button type="button" id="add-ticket-btn" class="mt-6 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg no-print">+ 티켓 종류 추가</button>
        </div>
         <div class="mt-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-300 print-text">B. 추가 수익원</h3>
          <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-gray-700"><th class="p-4 text-sm font-medium text-gray-400 print-text">항목</th><th class="p-4 text-sm font-medium text-gray-400 print-text">예상 매출액 (원)</th><th class="p-4"></th></tr></thead><tbody id="extra-revenue-table-body"></tbody><tfoot><tr class="border-t-2 border-gray-700 font-bold"><td class="p-4 print-text">추가 수익 합계</td><td class="p-4 print-text" id="total-extra-revenue">0 원</td><td></td></tr></tfoot></table></div>
          <button type="button" id="add-extra-revenue-btn" class="mt-6 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg no-print">+ 추가 수익원 추가</button>
        </div>
      </section>
      
      <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section">
        <h2 class="text-2xl font-bold text-white mb-6 pb-4 border-b border-gray-700 print-text">4. 비용 계획</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-gray-700"><th class="p-4 text-sm font-medium text-gray-400 print-text">항목</th><th class="p-4 text-sm font-medium text-gray-400 print-text">금액 (원)</th><th class="p-4"></th></tr></thead><tbody id="cost-table-body"></tbody><tfoot><tr class="border-t-2 border-gray-700 font-bold"><td class="p-4 print-text">총 예상 비용</td><td class="p-4 print-text" id="total-cost">0 원</td><td></td></tr></tfoot></table></div>
            <button type="button" id="add-cost-btn" class="mt-6 px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium rounded-lg no-print">+ 비용 항목 추가</button>
          </div>
          <div class="flex items-center justify-center min-h-[250px]"><canvas id="cost-chart"></canvas></div>
        </div>
      </section>

      <div class="text-center mt-12 flex flex-wrap justify-center gap-4 no-print">
        <button type="button" id="export-csv-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md">CSV 내보내기</button>
        <button type="button" id="print-btn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md">인쇄 / PDF 저장</button>
        <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg">투자 요청서 제출</button>
      </div>

      <section class="bg-gray-800 rounded-2xl p-8 mb-10 print-section mt-10">
        <h2 class="text-xl font-bold text-white mb-4 print-text">5. 담당자 연락처 / 첨부</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
          <div>
            <label for="contact-email" class="block text-sm font-medium text-gray-300 mb-2 print-text">이메일 <span class="text-red-500">*</span></label>
            <input type="email" id="contact-email" name="email" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" required>
          </div>
          <div>
            <label for="attachments" class="block text-sm font-medium text-gray-300 mb-2 print-text">첨부파일</label>
            <input type="file" id="attachments" name="attachments" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 print-input" accept=".pdf,.doc,.docx,.xlsx,.xls,.png,.jpg,.jpeg,.zip">
            <div class="text-gray-400 text-xs mt-1 print-text">최대 5MB</div>
          </div>
        </div>
      </section>
    </form>
  </div>
  <!-- 테이블 템플릿 -->
  <template id="ticket-row-template">
    <tr class="border-b border-gray-700">
      <td class="p-4 font-semibold text-sm print-text">티켓</td>
      <td class="p-4"><input type="text" class="ticket-type w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" data-original-value=""></td>
      <td class="p-4"><input type="number" class="ticket-quantity w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" min="0" data-original-value=""></td>
      <td class="p-4"><input type="number" class="ticket-price w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" min="0"></td>
      <td class="p-4 ticket-subtotal text-gray-400 print-text">₩0</td>
      <td class="p-4 text-right"><button type="button" class="remove-row-btn px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-md no-print">삭제</button></td>
    </tr>
  </template>
  <template id="extra-revenue-row-template">
     <tr class="border-b border-gray-700">
      <td class="p-4"><input type="text" class="extra-revenue-item w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" data-original-value=""></td>
      <td class="p-4"><input type="number" class="extra-revenue-amount w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" min="0" data-original-value=""></td>
      <td class="p-4 text-right"><button type="button" class="remove-row-btn px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-md no-print">삭제</button></td>
    </tr>
  </template>
   <template id="cost-row-template">
     <tr class="border-b border-gray-700">
      <td class="p-4"><input type="text" class="cost-item w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input"></td>
      <td class="p-4"><input type="number" class="cost-amount w-full bg-gray-700 border border-gray-600 rounded-lg p-2 print-input" min="0"></td>
      <td class="p-4 text-right"><button type="button" class="remove-row-btn px-2 py-1 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-md no-print">삭제</button></td>
    </tr>
  </template>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Globals & Selectors ---
    const form = document.getElementById('investment-form');
    const alertBox = document.getElementById('alert-box');
    let USD_KRW_RATE = 1350; // Default rate
    let costChart;

    // --- Debounce Function for Performance ---
    const debounce = (func, delay) => {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    };

    // --- API Simulation for Exchange Rate ---
    const fetchExchangeRate = async () => {
      document.getElementById('exchange-rate-info').textContent = '실시간 환율 조회중...';
      try {
        await new Promise(resolve => setTimeout(resolve, 500));
        USD_KRW_RATE = 1375.50; // 시뮬레이션
        document.getElementById('exchange-rate-info').textContent = `적용 환율: 1 USD = ${USD_KRW_RATE.toLocaleString()} KRW`;
        updateAllCalculations();
      } catch (error) {
        document.getElementById('exchange-rate-info').textContent = `환율 조회 실패. 기본값(${USD_KRW_RATE}) 적용.`;
      }
    };

    // --- Row Management using <template> ---
    const createRowManager = (tbody, templateId) => {
      const template = document.getElementById(templateId);
      tbody.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-row-btn')) {
          e.target.closest('tr').remove();
          updateAllCalculations();
        }
      });
      return (data = {}) => {
        const clone = template.content.cloneNode(true);
        for (const key in data) {
          const input = clone.querySelector(`.${key.replace(/([A-Z])/g, "-$1").toLowerCase()}`);
          if (input) input.value = data[key];
        }
        tbody.appendChild(clone);
      };
    };
    const addTicketRow = createRowManager(document.getElementById('ticket-table-body'), 'ticket-row-template');
    const addExtraRevenueRow = createRowManager(document.getElementById('extra-revenue-table-body'), 'extra-revenue-row-template');
    const addCostRow = createRowManager(document.getElementById('cost-table-body'), 'cost-row-template');

    // --- Formatting ---
    const formatCurrency = (amount) => new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);

    // --- Calculation Logic ---
    const getInvestmentAmountInKRW = () => {
      const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
      return document.getElementById('currency').value === 'USD' ? amount * USD_KRW_RATE : amount;
    };

    const updateAllCalculations = () => {
      if (!validateForm(false)) return;

      // Revenues
      let totalTicketRevenue = 0, totalQuantity = 0;
      document.getElementById('ticket-table-body').querySelectorAll('tr').forEach(row => {
        const quantity = parseInt(row.querySelector('.ticket-quantity')?.value) || 0;
        const price = parseInt(row.querySelector('.ticket-price')?.value) || 0;
        const subtotal = quantity * price;
        totalQuantity += quantity;
        totalTicketRevenue += subtotal;
        row.querySelector('.ticket-subtotal').textContent = formatCurrency(subtotal);
      });
      document.getElementById('total-quantity').textContent = totalQuantity.toLocaleString('ko-KR');
      document.getElementById('total-revenue').textContent = formatCurrency(totalTicketRevenue);
      
      let totalExtraRevenue = 0;
      document.getElementById('extra-revenue-table-body').querySelectorAll('.extra-revenue-amount').forEach(input => totalExtraRevenue += parseInt(input.value) || 0);
      document.getElementById('total-extra-revenue').textContent = formatCurrency(totalExtraRevenue);

      // Costs
      let totalCost = 0;
      document.getElementById('cost-table-body').querySelectorAll('.cost-amount').forEach(input => totalCost += parseInt(input.value) || 0);
      document.getElementById('total-cost').textContent = formatCurrency(totalCost);

      // Financial Summary
      const totalRevenue = totalTicketRevenue + totalExtraRevenue;
      const estimatedProfit = totalRevenue - totalCost;
      const investmentAmountKRW = getInvestmentAmountInKRW();
      const roi = investmentAmountKRW > 0 ? (estimatedProfit / investmentAmountKRW) * 100 : 0;
      const bepRate = totalRevenue > 0 ? (totalCost / totalRevenue) * 100 : 0;

      // Update Displays
      document.getElementById('bep-amount-display').value = formatCurrency(totalCost);
      document.getElementById('bep-rate-display').value = `${bepRate.toFixed(2)}%`;
      document.getElementById('summary-investment').textContent = formatCurrency(investmentAmountKRW);
      document.getElementById('summary-revenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('summary-profit').textContent = formatCurrency(estimatedProfit);
      document.getElementById('summary-roi').textContent = `${roi.toFixed(2)}%`;

      updateCostChart();
    };

    // --- Chart Logic ---
    const updateCostChart = () => {
      const ctx = document.getElementById('cost-chart').getContext('2d');
      const labels = [], data = [];
      document.getElementById('cost-table-body').querySelectorAll('tr').forEach(row => {
        const item = row.querySelector('.cost-item')?.value || '기타';
        const amount = parseInt(row.querySelector('.cost-amount')?.value) || 0;
        if (amount > 0) {
          labels.push(item);
          data.push(amount);
        }
      });

      if (costChart) costChart.destroy();
      costChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{ data, backgroundColor: ['#4f46e5', '#38a169', '#dd6b20', '#d53f8c', '#805ad5', '#3182ce'], borderColor: '#1f232d' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top', labels: { color: '#a0aec0' } }, title: { display: true, text: '비용 구조', color: '#f8fafc', font: { size: 16 } } }
        }
      });
    };

    // --- Data Validation ---
    const validateForm = (showAlert = true) => {
      let isValid = true, msg = "";
      // Date validation
      const startDate = document.getElementById('investment-period-start');
      const endDate = document.getElementById('investment-period-end');
      const errorDiv = document.getElementById('investment-period-error');
      if (startDate.value && endDate.value && startDate.value > endDate.value) {
        startDate.classList.add('validation-error');
        endDate.classList.add('validation-error');
        errorDiv.textContent = '종료일은 시작일보다 빠를 수 없습니다.';
        msg = '투자기간 오류';
        isValid = false;
      } else {
        startDate.classList.remove('validation-error');
        endDate.classList.remove('validation-error');
        errorDiv.textContent = '';
      }
      // 필수 입력값
      const requiredIds = ['performance-name','artist-name','investment-amount','investment-period-start','investment-period-end','contact-email'];
      for(const id of requiredIds){
        const el = document.getElementById(id);
        if(!el.value || (el.type==="number" && Number(el.value)<0)){
          el.classList.add('validation-error');
          msg = '모든 필수 항목을 입력해 주세요.';
          isValid = false;
        }else{
          el.classList.remove('validation-error');
        }
      }
      // 첨부파일 5MB 제한
      const file = document.getElementById('attachments').files[0];
      if(file && file.size > 5*1024*1024){
        document.getElementById('attachments').classList.add('validation-error');
        msg = '첨부파일은 5MB 이내여야 합니다.';
        isValid = false;
      }else{
        document.getElementById('attachments').classList.remove('validation-error');
      }
      if(showAlert){
        alertBox.innerHTML = isValid ? '' : `<div class="alert alert-error">${msg}</div>`;
      }
      return isValid;
    };

    // --- Scenario Analysis ---
    const applyScenario = (rate) => {
      document.querySelectorAll('.ticket-quantity, .extra-revenue-amount').forEach(input => {
        if (rate === 1.0) {
          input.value = input.dataset.originalValue || input.value;
        } else {
          if (!input.dataset.originalValue) input.dataset.originalValue = input.value;
          input.value = Math.round((parseInt(input.dataset.originalValue) || 0) * rate);
        }
      });
      updateAllCalculations();
    };

    // --- Export to CSV ---
    const exportToCSV = () => {
      let csvContent = "data:text/csv;charset=utf-8,구분,항목,금액\n";
      document.querySelectorAll('#ticket-table-body tr').forEach(row => {
        const type = row.querySelector('.ticket-type').value;
        const subtotal = row.querySelector('.ticket-subtotal').textContent.replace(/[^\d]/g, '');
        csvContent += `수익,티켓 - ${type},${subtotal}\n`;
      });
      document.querySelectorAll('#extra-revenue-table-body tr').forEach(row => {
        const item = row.querySelector('.extra-revenue-item').value;
        const amount = row.querySelector('.extra-revenue-amount').value;
        csvContent += `수익,${item},${amount}\n`;
      });
      document.querySelectorAll('#cost-table-body tr').forEach(row => {
        const item = row.querySelector('.cost-item').value;
        const amount = row.querySelector('.cost-amount').value;
        csvContent += `비용,${item},${amount}\n`;
      });
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `investment_proposal_${new Date().toISOString().slice(0,10)}.csv`);
      document.body.appendChild(link);
      link.click();
      link.remove();
    };
    
    // --- Event Listeners ---
    const debouncedUpdate = debounce(updateAllCalculations, 300);
    form.addEventListener('input', debouncedUpdate);
    document.getElementById('add-ticket-btn').addEventListener('click', () => addTicketRow());
    document.getElementById('add-extra-revenue-btn').addEventListener('click', () => addExtraRevenueRow());
    document.getElementById('add-cost-btn').addEventListener('click', () => addCostRow());
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
    document.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', (e) => applyScenario(parseFloat(e.target.dataset.rate)));
    });

    // --- Form Submission (Formspree AJAX) ---
    form.onsubmit = function(e){
      e.preventDefault();
      alertBox.innerHTML = '';
      if(!validateForm(true)) return;
      const btn = form.querySelector('button[type=submit]');
      btn.disabled = true; btn.textContent="제출 중...";

      fetch(form.action, {
        method: "POST",
        body: new FormData(form),
        headers: { Accept: "application/json" }
      }).then(res => res.ok ? res.json() : Promise.reject(res))
        .then(() => {
          alertBox.innerHTML = `<div class="alert alert-success">제출이 완료되었습니다! 담당자가 개별 연락드립니다.</div>`;
          btn.disabled = false; btn.textContent="투자 요청서 제출";
          form.reset();
          updateAllCalculations();
          window.scrollTo({top:0, behavior:'smooth'});
        }).catch(()=>{
          alertBox.innerHTML = `<div class="alert alert-error">오류가 발생했습니다. 다시 시도해 주세요.</div>`;
          btn.disabled = false; btn.textContent="투자 요청서 제출";
        });
    };

    // --- Initialization ---
    fetchExchangeRate();
    addTicketRow({ ticketType: 'VIP', ticketQuantity: '100', ticketPrice: '150000' });
    addTicketRow({ ticketType: 'R석', ticketQuantity: '300', ticketPrice: '120000' });
    addExtraRevenueRow({ extraRevenueItem: '공식 굿즈(MD)', extraRevenueAmount: '5000000' });
    addCostRow({ costItem: '대관료', costAmount: '10000000' });
    addCostRow({ costItem: '아티스트 개런티', costAmount: '20000000' });
    addCostRow({ costItem: '마케팅 및 홍보', costAmount: '3000000' });
    updateAllCalculations();
  });
  </script>
</body>
</html>
