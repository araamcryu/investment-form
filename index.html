import React, { useState } from "react";
import emailjs from "@emailjs/browser";

const initialCost = [
  { name: "아티스트 개런티", amount: "" },
  { name: "대관비용", amount: "" },
  { name: "연출비용", amount: "" }
];
const initialRevenue = [{ name: "티켓수익", amount: "" }];

export default function App() {
  const [projectName, setProjectName] = useState("");
  const [projectType, setProjectType] = useState([]);
  const [artist, setArtist] = useState("");
  const [venue, setVenue] = useState("");
  const [seatCount, setSeatCount] = useState("");
  const [ticketTypes, setTicketTypes] = useState([{ type: "", count: "", price: "" }]);
  const [requestAmount, setRequestAmount] = useState("");
  const [periods, setPeriods] = useState({
    showStart: "", showEnd: "",
    investStart: "", investEnd: "",
    principalReturnStart: "", principalReturnEnd: "",
    profitDistStart: "", profitDistEnd: "",
  });
  const [investorShare, setInvestorShare] = useState(70);
  const [ownerShare, setOwnerShare] = useState(30);
  const [costs, setCosts] = useState(initialCost);
  const [revenues, setRevenues] = useState(initialRevenue);
  const [files, setFiles] = useState([]);
  const [submitted, setSubmitted] = useState(false);
  const [loading, setLoading] = useState(false);

  // 계산
  const totalCost = costs.reduce((acc, c) => acc + (Number(c.amount) || 0), 0);
  const totalRevenue = revenues.reduce((acc, r) => acc + (Number(r.amount) || 0), 0);
  const ROI = totalCost > 0 ? ((totalRevenue - totalCost) / totalCost * 100).toFixed(2) : 0;
  const BEP = totalCost > 0 ? totalCost / (ticketTypes.reduce((acc, t) => acc + ((Number(t.price) || 0)), 0) || 1) : 0;
  const investorProfit = totalRevenue * (investorShare / 100);
  const ownerProfit = totalRevenue * (ownerShare / 100);

  // 핸들러
  const handleType = (type) => {
    setProjectType((prev) =>
      prev.includes(type) ? prev.filter((t) => t !== type) : [...prev, type]
    );
  };
  const handleTicketTypes = (idx, key, val) => {
    const copy = [...ticketTypes];
    copy[idx][key] = val;
    setTicketTypes(copy);
  };
  const addTicketType = () => setTicketTypes([...ticketTypes, { type: "", count: "", price: "" }]);
  const handleCost = (idx, key, val) => {
    const copy = [...costs];
    copy[idx][key] = val;
    setCosts(copy);
  };
  const addCost = () => setCosts([...costs, { name: "", amount: "" }]);
  const handleRevenue = (idx, key, val) => {
    const copy = [...revenues];
    copy[idx][key] = val;
    setRevenues(copy);
  };
  const addRevenue = () => setRevenues([...revenues, { name: "", amount: "" }]);
  const handleFile = (e) => setFiles(Array.from(e.target.files));

  // EmailJS 전송
  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    // 데이터 요약 생성
    const formSummary = `
[사업명] ${projectName}
[사업유형] ${projectType.join(", ")}
[아티스트] ${artist}
[콘서트장] ${venue} (좌석수: ${seatCount})
[티켓종류] ${ticketTypes.map(t=>`${t.type}: ${t.count}석 × ${t.price}원`).join("; ")}
[투자요청금액] ${requestAmount}원
[기간]
- 콘서트: ${periods.showStart} ~ ${periods.showEnd}
- 투자금 운용: ${periods.investStart} ~ ${periods.investEnd}
- 원금회수: ${periods.principalReturnStart} ~ ${periods.principalReturnEnd}
- 수익분배: ${periods.profitDistStart} ~ ${periods.profitDistEnd}
[수익배분] 투자자 ${investorShare}%, 사업주체 ${ownerShare}%
[비용] ${costs.map(c=>`${c.name}: ${c.amount}`).join("; ")}
[수익] ${revenues.map(r=>`${r.name}: ${r.amount}`).join("; ")}
----------------
[자동계산]
총비용: ${totalCost}원
총수익: ${totalRevenue}원
ROI: ${ROI}%
BEP: ${BEP}매 (티켓 단가별)
투자자 몫: ${investorProfit}원 / 사업주체 몫: ${ownerProfit}원
----------------
`;

    // 파일 첨부는 EmailJS 템플릿에서 input[file] 항목을 활용
    const formData = new FormData();
    formData.append("message", formSummary);
    files.forEach((file, i) => formData.append(`file${i+1}`, file, file.name));

    try {
      await emailjs.sendForm(
        "YOUR_SERVICE_ID",     // EmailJS 서비스 ID
        "YOUR_TEMPLATE_ID",    // EmailJS 템플릿 ID
        formData,
        "YOUR_PUBLIC_KEY"      // EmailJS public key
      );
      setSubmitted(true);
    } catch (e) {
      alert("메일 전송 오류:" + e.text);
    }
    setLoading(false);
  };

  return (
    <div style={{ maxWidth: 800, margin: "40px auto", fontFamily: "Noto Sans KR, sans-serif", padding: 24, background: "#f8f9fa", borderRadius: 16 }}>
      <h2>엔터테인먼트 투자제안 자동계산/접수</h2>
      <form onSubmit={handleSubmit} encType="multipart/form-data">
        <h4>1. 사업 기본정보</h4>
        <div>
          사업명: <input value={projectName} onChange={e => setProjectName(e.target.value)} style={{ width: 220 }}/>
        </div>
        <div>
          사업유형: 
          {["콘서트", "팬미팅", "MD수입", "굿즈", "기타"].map(type =>
            <label key={type} style={{ marginLeft: 8 }}>
              <input type="checkbox" checked={projectType.includes(type)} onChange={() => handleType(type)}/> {type}
            </label>
          )}
        </div>
        <div>
          아티스트명: <input value={artist} onChange={e => setArtist(e.target.value)} style={{ width: 200 }}/>
        </div>
        <div>
          콘서트장 위치/규모: <input value={venue} onChange={e => setVenue(e.target.value)} style={{ width: 240 }}/>
          &nbsp;좌석수: <input value={seatCount} onChange={e => setSeatCount(e.target.value)} type="number" style={{ width: 80 }}/>
        </div>

        <h4>2. 티켓 설정</h4>
        {ticketTypes.map((t, i) => (
          <div key={i} style={{ marginBottom: 4 }}>
            티켓종류: <input value={t.type} onChange={e => handleTicketTypes(i, "type", e.target.value)} style={{ width: 80 }}/>
            좌석수: <input value={t.count} type="number" onChange={e => handleTicketTypes(i, "count", e.target.value)} style={{ width: 60 }}/>
            금액: <input value={t.price} type="number" onChange={e => handleTicketTypes(i, "price", e.target.value)} style={{ width: 80 }}/>
          </div>
        ))}
        <button type="button" onClick={addTicketType}>+ 티켓 추가</button>

        <h4>3. 투자 요청</h4>
        <div>
          투자요청금액(KRW): <input value={requestAmount} onChange={e => setRequestAmount(e.target.value)} type="number" style={{ width: 160 }}/>
        </div>
        <div>
          <span>콘서트 시작일: <input type="date" value={periods.showStart} onChange={e => setPeriods({ ...periods, showStart: e.target.value })}/></span>
          <span style={{ marginLeft: 16 }}>콘서트 종료일: <input type="date" value={periods.showEnd} onChange={e => setPeriods({ ...periods, showEnd: e.target.value })}/></span>
        </div>
        <div>
          투자금 운용기간: 
          <input type="date" value={periods.investStart} onChange={e => setPeriods({ ...periods, investStart: e.target.value })}/> ~ 
          <input type="date" value={periods.investEnd} onChange={e => setPeriods({ ...periods, investEnd: e.target.value })}/>
        </div>
        <div>
          원금회수기간: 
          <input type="date" value={periods.principalReturnStart} onChange={e => setPeriods({ ...periods, principalReturnStart: e.target.value })}/> ~ 
          <input type="date" value={periods.principalReturnEnd} onChange={e => setPeriods({ ...periods, principalReturnEnd: e.target.value })}/>
        </div>
        <div>
          투자수익분배기간: 
          <input type="date" value={periods.profitDistStart} onChange={e => setPeriods({ ...periods, profitDistStart: e.target.value })}/> ~ 
          <input type="date" value={periods.profitDistEnd} onChange={e => setPeriods({ ...periods, profitDistEnd: e.target.value })}/>
        </div>
        
        <h4>4. 수익 배분</h4>
        <div>
          투자자: <input type="number" value={investorShare} min={0} max={100} onChange={e => {
            let val = Math.min(100, Math.max(0, Number(e.target.value)));
            setInvestorShare(val);
            setOwnerShare(100 - val);
          }} style={{ width: 60 }}/> %
          &nbsp;사업주체: <input type="number" value={ownerShare} min={0} max={100} onChange={e => {
            let val = Math.min(100, Math.max(0, Number(e.target.value)));
            setOwnerShare(val);
            setInvestorShare(100 - val);
          }} style={{ width: 60 }}/> %
          <span style={{ color: investorShare + ownerShare !== 100 ? "red" : "#222", marginLeft: 12 }}>
            (합계: {investorShare + ownerShare}%)
          </span>
        </div>

        <h4>5. 비용 내역</h4>
        {costs.map((c, i) => (
          <div key={i} style={{ marginBottom: 4 }}>
            <input value={c.name} onChange={e => handleCost(i, "name", e.target.value)} placeholder="비용명" style={{ width: 120 }}/>
            <input value={c.amount} type="number" onChange={e => handleCost(i, "amount", e.target.value)} placeholder="금액" style={{ width: 120 }}/>
          </div>
        ))}
        <button type="button" onClick={addCost}>+ 비용 추가</button>

        <h4>6. 수익 내역</h4>
        {revenues.map((r, i) => (
          <div key={i} style={{ marginBottom: 4 }}>
            <input value={r.name} onChange={e => handleRevenue(i, "name", e.target.value)} placeholder="수익명" style={{ width: 120 }}/>
            <input value={r.amount} type="number" onChange={e => handleRevenue(i, "amount", e.target.value)} placeholder="금액" style={{ width: 120 }}/>
          </div>
        ))}
        <button type="button" onClick={addRevenue}>+ 수익 추가</button>

        <h4>7. 첨부파일</h4>
        <input type="file" multiple onChange={handleFile} />
        {files.length > 0 && (
          <ul>{Array.from(files).map((f, i) => <li key={i}>{f.name}</li>)}</ul>
        )}

        <hr style={{ margin: "24px 0" }}/>

        <h4>자동 계산 결과</h4>
        <div>총 비용: {totalCost.toLocaleString()} 원</div>
        <div>총 수익: {totalRevenue.toLocaleString()} 원</div>
        <div>ROI: {ROI}%</div>
        <div>BEP(손익분기점): {BEP.toLocaleString(undefined, { maximumFractionDigits: 0 })} 매(티켓 단가별)</div>
        <div>투자자 몫: {investorProfit.toLocaleString()} 원 / 사업주체 몫: {ownerProfit.toLocaleString()} 원</div>

        <button type="submit" disabled={loading} style={{ marginTop: 24, fontWeight: 700, padding: "8px 24px" }}>
          {loading ? "전송중..." : "접수"}
        </button>
      </form>

      {submitted && (
        <div style={{ background: "#e2ffe2", marginTop: 24, padding: 16, borderRadius: 10 }}>
          <b>접수 완료!</b><br/>
          입력하신 내용은 관리자 이메일로 전송되었습니다.
        </div>
      )}
    </div>
  );
}
