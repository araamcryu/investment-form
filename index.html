<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>UJIN ENTERTAINMENT 전용 투자 제안서 생성기</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color-start: #1D2B64;
            --bg-color-end: #000000;
            --card-bg-color: rgba(22, 24, 30, 0.6);
            --input-bg-color: rgba(10, 12, 18, 0.7);
            --primary-color: #8A3FFC; /* Vibrant Violet */
            --primary-light-color: #BE95FF;
            --text-color: #F8F9FA;
            --text-muted-color: #ADB5BD;
            --border-color: rgba(255, 255, 255, 0.15);
            --error-color: #ff6384;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            margin: 0;
            background: linear-gradient(-45deg, #1D2B64, #F8CDDA, #1D2B64, #000000);
            background-size: 400% 400%;
            animation: gradientAnimation 25s ease infinite;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            color: var(--text-color); min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; overflow-x: hidden;
        }
        .main-wrap { width: 100%; max-width: 900px; }
        .title {
            font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 2rem;
            color: var(--text-color); text-shadow: 0 0 20px var(--primary-light-color), var(--text-shadow);
        }
        .glass-card {
            background: var(--card-bg-color); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 25px; border: 1px solid var(--border-color); padding: 35px;
            box-shadow: 0 16px 45px 0 var(--shadow-color);
        }
        .progress-bar {
            display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative;
            transition: opacity 0.5s ease;
        }
        .progress-bar::before {
            content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%);
            height: 4px; width: 100%; background: var(--input-bg-color); border-radius: 2px; z-index: 1;
        }
        .progress-bar .progress {
            position: absolute; top: 50%; left: 0; transform: translateY(-50%);
            height: 4px; background: var(--primary-color); z-index: 2; border-radius: 2px;
            width: 0%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .progress-step {
            width: 38px; height: 38px; background: var(--input-bg-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-weight: 600;
            border: 2px solid var(--border-color); z-index: 3; transition: all 0.4s ease;
        }
        .progress-step.active {
            background: var(--primary-color); border-color: var(--primary-light-color);
            color: #fff; transform: scale(1.15); box-shadow: 0 0 15px var(--primary-color);
        }
        .form-step { display: none; animation: fadeIn 0.6s ease-out; }
        .form-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-section h2 {
            font-size: 1.6rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 1rem;
            color: var(--primary-light-color); text-shadow: var(--text-shadow);
            border-bottom: 1px solid var(--border-color);
        }
        .error-message { color: var(--error-color); margin-bottom: 1rem; display: none; font-size: 0.9rem; font-weight: 500; }
        .form-row { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .form-label { min-width: 140px; font-size: 1rem; font-weight: 500; color: var(--text-muted-color); text-shadow: var(--text-shadow); }
        input, select, textarea {
            font-family: inherit; font-size: 1rem; border-radius: 10px; border: 1px solid var(--border-color);
            padding: 13px 16px; background: var(--input-bg-color); color: var(--text-color);
            transition: all 0.3s ease; flex-grow: 1;
        }
        textarea { min-height: 80px; resize: vertical; }
        input:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(138, 63, 252, 0.3);
        }
        .input-group {
            display: flex; align-items: center; flex-grow: 1; background: var(--input-bg-color);
            border-radius: 10px; border: 1px solid var(--border-color); transition: all 0.3s ease;
        }
        .input-group input { border: none; background: transparent; }
        .input-group input:focus { box-shadow: none; }
        .input-group:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(138, 63, 252, 0.3); }
        .input-unit { padding-right: 16px; color: var(--text-muted-color); font-weight: 500; }
        .btn {
            background: var(--primary-color); color: #fff; border: none; padding: 13px 26px;
            border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(138, 63, 252, 0.2);
        }
        .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(138, 63, 252, 0.3); }
        .btn:disabled { background: var(--text-muted-color); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .btn.btn-secondary { background: var(--input-bg-color); box-shadow: none; border: 1px solid var(--border-color); }
        .btn.btn-secondary:hover { background: var(--primary-color); border-color: var(--primary-color); }
        .btn.add-item-btn { width: auto; flex-grow: 0; }
        .dynamic-list-container { padding: 1rem 0; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .dynamic-list-container:last-of-type { border-bottom: none; }
        .dynamic-list-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .del-btn {
            background: rgba(255, 99, 132, 0.2); border: 1px solid rgba(255, 99, 132, 0.5);
            color: #ff6384; padding: 10px 16px; border-radius: 8px; font-size: 0.8rem; flex-shrink: 0;
        }
        .del-btn:hover { background: #ff6384; color: #fff; }
        
        /* Bento Grid Layout */
        #bento-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto;
        }
        .bento-item {
            background: var(--input-bg-color); border-radius: 12px; padding: 20px;
            border: 1px solid var(--border-color); font-size: 1.05rem;
        }
        .bento-item h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary-light-color); }
        .bento-item-1 { grid-column: span 3; } /* Project Name */
        .bento-item-2 { grid-column: span 2; grid-row: span 2; } /* Overview */
        .bento-item-3 { grid-column: span 1; } /* Attachments */
        .bento-item-4 { grid-column: span 1; } /* Summary */
        .bento-item-5 { grid-column: span 3; } /* Advanced Analytics */
        .bento-item-6 { grid-column: span 3; } /* AI Risk Analysis */
        .bento-item-7 { grid-column: span 3; } /* AI Summary */
        
        .result-card b { color: var(--primary-light-color); font-weight: 600; }
        .slider-row { display: flex; align-items: center; gap: 1rem; }
        .slider-row input[type=range] { flex-grow: 1; }
        details summary { font-weight: 600; cursor: pointer; }
        .bep-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        .bep-table th, .bep-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #fileList { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-radius: 5px; background-color: var(--bg-color); margin-bottom: 5px; }
        .pdf-export-mode .glass-card { background: #ffffff !important; color: #000000 !important; --text-color: #000000; --text-muted-color: #444444; --primary-light-color: #0056b3; --input-bg-color: #f8f9fa; --border-color: #dee2e6; }
        .pdf-export-mode h1, .pdf-export-mode h2, .pdf-export-mode h3, .pdf-export-mode .form-label, .pdf-export-mode .input-unit, .pdf-export-mode .bento-item { text-shadow: none !important; }
        
        #submission-success { text-align: center; }
        #submission-success h2 { color: var(--primary-light-color); font-size: 2.2rem; margin-bottom: 1rem; }
        #submission-success p { font-size: 1.1rem; line-height: 1.7; color: var(--text-muted-color); margin-bottom: 2.5rem; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .title { font-size: 2rem; }
            .glass-card { padding: 20px; }
            .form-row { flex-direction: column; align-items: flex-start; gap: 8px; }
            .form-label { min-width: 100%; margin-bottom: 4px; }
            .btn-group { flex-direction: column; gap: 1rem; }
            #bento-grid { grid-template-columns: 1fr; }
            .bento-item-1, .bento-item-2, .bento-item-3, .bento-item-4, .bento-item-5, .bento-item-6, .bento-item-7 { grid-column: span 1; grid-row: span 1; }
            .dynamic-list-item { flex-direction: column; align-items: stretch; }
            .dynamic-list-item > * { width: 100% !important; }
            .dynamic-list-item .del-btn { margin-top: 8px; }
        }
    </style>
</head>
<body>
<div class="main-wrap">
    <h1 class="title">UJIN ENTERTAINMENT 전용</h1>
    <div class="glass-card" id="main-card">
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
            <div class="progress-step active" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
        </div>
        <form id="mainForm">
            <!-- Step 1: 기본 정보 -->
            <div class="form-step active" id="step-1">
                <div class="form-section">
                    <h2>1단계: 사업 개요</h2>
                    <div class="error-message"></div>
                    <div class="form-row"><span class="form-label">사업명</span><input name="projectName" required></div>
                    <div class="form-row"><span class="form-label">아티스트명</span><input name="artist" required></div>
                    <div class="form-row"><span class="form-label">프로젝트 개요</span><textarea name="projectOverview" placeholder="프로젝트의 목표, 비전, 핵심 내용을 요약합니다."></textarea></div>
                    <div class="form-row"><span class="form-label">특이사항 및 기대효과</span><textarea name="specialNotes" placeholder="본 사업의 차별점, 강점, 예상되는 긍정적 효과를 기술합니다."></textarea></div>
                    <div class="form-row">
                        <span class="form-label"></span>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateOverviewBtn">✨ AI로 개요 자동 작성</button>
                    </div>
                    <div class="form-row"><span class="form-label">첨부 파일</span>
                        <div style="flex-grow: 1;">
                            <input type="file" id="fileUpload" multiple style="display:none;">
                            <button type="button" class="btn btn-secondary add-item-btn" onclick="document.getElementById('fileUpload').click();">파일 선택</button>
                            <div id="fileList"></div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <span></span>
                    <button type="button" class="btn" data-next>다음 단계 &rarr;</button>
                </div>
            </div>

            <!-- Step 2: 비용 및 수익 -->
            <div class="form-step" id="step-2">
                <div class="form-section">
                    <h2>2단계: 재무 정보</h2>
                    <div class="error-message"></div>
                    <div class="form-row"><span class="form-label">콘서트장 위치</span><input name="venue" required></div>
                    <div class="form-row"><span class="form-label">총 좌석수</span><input type="text" inputmode="numeric" name="seatCount" class="auto-format" required></div>
                    <div class="form-row"><span class="form-label">콘서트일정</span><input type="date" name="showStart"> ~ <input type="date" name="showEnd"></div>
                    <div class="form-row">
                        <span class="form-label">투자요청금액</span>
                        <div class="input-group"><input type="text" inputmode="numeric" name="requestAmount" class="auto-format" required placeholder="예: 10,000"><span class="input-unit">만원</span></div>
                    </div>
                    <div class="form-row">
                        <span class="form-label">수익배분 (투자자)</span>
                        <div class="input-group"><input type="number" name="investorShare" min="0" max="100" value="70" required><span class="input-unit">%</span></div>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">티켓 정보</h3>
                        <div class="ticket-list" id="ticketList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addTicketBtn" style="margin-top: 1rem;">+ 티켓추가</button>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">비용 내역</h3>
                        <div class="form-row">
                            <span class="form-label">아티스트 개런티</span>
                            <div class="input-group"><input type="text" inputmode="numeric" name="artistFee" class="auto-format" required placeholder="가장 큰 비중을 차지하는 비용"><span class="input-unit">만원</span></div>
                        </div>
                        <div class="form-row">
                            <span class="form-label">베뉴 (대관) 비용</span>
                            <div class="input-group"><input type="text" inputmode="numeric" name="venueFee" class="auto-format" required placeholder="공연장 대관료 등"><span class="input-unit">만원</span></div>
                        </div>
                        <div class="cost-list" id="costList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addCostBtn" style="margin-top: 1rem;">+ 기타 비용추가</button>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateCostItemsBtn" style="margin-top: 1rem; margin-left: 10px;">✨ AI 예상 비용 추천</button>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">기타 수익 내역</h3>
                        <div class="rev-list" id="revList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addRevBtn" style="margin-top: 1rem;">+ 수익추가</button>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateRevenueItemsBtn" style="margin-top: 1rem; margin-left: 10px;">✨ AI 추가 수익원 추천</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" data-prev>&larr; 이전 단계</button>
                    <button type="button" class="btn" data-next>결과 확인 &rarr;</button>
                </div>
            </div>

            <!-- Step 3: 결과 확인 -->
            <div class="form-step" id="step-3">
                <div id="result">
                    <div id="pdf-content">
                        <div id="bento-grid">
                            <div class="bento-item bento-item-1">
                                <h2 id="finalProjectName" style="border:none; padding-bottom: 0; margin-bottom: 0.5rem; text-align: center;"></h2>
                                <p id="finalArtistName" style="margin:0; color: var(--text-muted-color); text-align: center; margin-top: -0.5rem; margin-bottom: 1rem;"></p>
                            </div>
                            <div class="bento-item bento-item-2">
                                <h3>프로젝트 개요</h3>
                                <p id="finalProjectOverview"></p>
                                <h3>특이사항 및 기대효과</h3>
                                <p id="finalSpecialNotes"></p>
                            </div>
                             <div class="bento-item bento-item-3">
                                <h3>첨부 파일 목록</h3>
                                <ul id="finalAttachmentsList" style="list-style-type: none; padding-left: 0;"></ul>
                            </div>
                            <div class="bento-item bento-item-4 result-card" id="result-summary"></div>
                             <div class="bento-item bento-item-7">
                                <h3>AI 투자 제안 요약</h3>
                                <button type="button" class="btn btn-secondary" id="generateSummaryBtn">✨ AI로 요약 생성하기</button>
                                <p id="aiSummary" style="margin-top: 1rem; white-space: pre-wrap;"></p>
                            </div>
                            <div class="bento-item bento-item-5">
                                <details>
                                    <summary>고급 분석 보기</summary>
                                    <div id="advanced-analytics" style="margin-top:1rem;">
                                        <h4>시나리오 시뮬레이션</h4>
                                        <div class="slider-row">
                                            <label>티켓 판매율:</label>
                                            <input type="range" id="salesRateSlider" min="50" max="120" value="100">
                                            <span id="salesRateLabel">100%</span>
                                        </div>
                                        <div id="simulationResult"></div>
                                        <h4 style="margin-top: 1.5rem;">등급별 손익분기점(BEP) 분석</h4>
                                        <table class="bep-table" id="bepTable"></table>
                                    </div>
                                </details>
                            </div>
                             <div class="bento-item bento-item-6">
                                <h3>AI 리스크 분석</h3>
                                <button type="button" class="btn btn-secondary" id="analyzeRiskBtn">✨ AI로 리스크 분석하기</button>
                                <div id="riskAnalysisResult" style="margin-top: 1rem; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" data-prev>&larr; 이전 단계</button>
                    <button type="button" class="btn" id="savePdfBtn">PDF로 저장</button>
                </div>
                 <button type="button" class="btn" id="submitBtn" style="margin-top: 1rem; width: 100%;">제출하기</button>
            </div>
        </form>
        <div id="submission-success" style="display: none; animation: fadeIn 0.6s ease-out;">
            <h2>제출 완료</h2>
            <p id="submission-message"></p>
            <button type="button" class="btn" id="startNewBtn">새 제안서 작성하기</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainForm = document.getElementById('mainForm');
    
    // --- 자동 포맷팅 함수 ---
    const formatNumberInput = (input) => {
        if (!input) return;
        let value = input.value.replace(/,/g, '');
        if (isNaN(value) || value.trim() === '') {
            input.value = '';
        } else {
            input.value = parseInt(value, 10).toLocaleString('en-US');
        }
    };
    const getUnformattedValue = (value) => {
        return value.replace(/,/g, '') || '0';
    };
    mainForm.addEventListener('input', (e) => {
        if (e.target.classList.contains('auto-format')) {
            formatNumberInput(e.target);
        }
    });

    // --- Navigation ---
    const prevBtns = document.querySelectorAll('[data-prev]');
    const nextBtns = document.querySelectorAll('[data-next]');
    const progress = document.getElementById('progress');
    const steps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.progress-step');
    let currentStep = 1;

    nextBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                updateFormSteps();
            }
        });
    });
    prevBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentStep--;
            updateFormSteps();
        });
    });

    const updateFormSteps = () => {
        steps.forEach(step => step.classList.remove('active'));
        const currentStepEl = document.querySelector(`#step-${currentStep}`);
        if (currentStepEl) {
            currentStepEl.classList.add('active');
        }
        
        progressSteps.forEach((step, idx) => {
            step.classList.toggle('active', idx < currentStep);
        });
        
        progress.style.width = `${((currentStep - 1) / (steps.length - 1)) * 100}%`;
        
        if (currentStep === 3) {
            displayFinalResults();
        }
    };
    
    const validateStep = (stepNumber) => {
        const currentStepEl = document.getElementById(`step-${stepNumber}`);
        const errorDiv = currentStepEl.querySelector('.error-message');
        const inputs = currentStepEl.querySelectorAll('input[required], textarea[required]');
        let isValid = true;
        errorDiv.style.display = 'none';
        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.style.borderColor = 'var(--error-color)';
                isValid = false;
            } else {
                input.style.borderColor = 'var(--border-color)';
            }
        });
        if (!isValid) {
            errorDiv.textContent = '현재 단계의 모든 필수 항목을 입력해주세요.';
            errorDiv.style.display = 'block';
        }
        return isValid;
    };
    
    mainForm.addEventListener('input', (e) => {
        const target = e.target;
        if ((target.tagName === 'INPUT' && target.hasAttribute('required')) || (target.tagName === 'TEXTAREA' && target.hasAttribute('required'))) {
            if (target.value.trim()) {
                target.style.borderColor = 'var(--border-color)';
                const errorDiv = target.closest('.form-step').querySelector('.error-message');
                if (errorDiv) errorDiv.style.display = 'none';
            }
        }
    });

    // --- File Upload ---
    const fileUpload = document.getElementById('fileUpload');
    const fileListDiv = document.getElementById('fileList');
    let attachedFiles = [];

    fileUpload.addEventListener('change', function() {
        attachedFiles = Array.from(this.files);
        updateFileListUI();
        saveData();
    });

    function updateFileListUI() {
        fileListDiv.innerHTML = '';
        attachedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name}</span><button type="button" class="del-btn" data-index="${index}">삭제</button>`;
            fileListDiv.appendChild(fileItem);
        });
    }

    fileListDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('del-btn')) {
            const index = parseInt(e.target.dataset.index, 10);
            attachedFiles.splice(index, 1);
            updateFileListUI();
            saveData();
        }
    });

    // --- Data, Calc ---
    const STORAGE_KEY = 'investmentProposalData_v12_final';

    const saveData = () => {
        const data = {};
        const inputs = mainForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type !== 'file' && input.name) data[input.name] = input.value;
        });
        data.fileNames = attachedFiles.map(f => f.name);
        data.otherCosts = Array.from(document.getElementById('costList').querySelectorAll('.dynamic-list-item')).map(item => ({ name: item.querySelector('.costname').value, value: item.querySelector('.costval').value }));
        data.revenues = Array.from(document.getElementById('revList').querySelectorAll('.dynamic-list-item')).map(item => ({ name: item.querySelector('.revname').value, value: item.querySelector('.revval').value }));
        data.tickets = Array.from(document.getElementById('ticketList').querySelectorAll('.dynamic-list-item')).map(item => ({ type: item.querySelector('.ticketType').value, count: item.querySelector('.ticketCount').value, price: item.querySelector('.ticketPrice').value }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    };

    const loadData = (data) => {
        const inputs = mainForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type !== 'file' && input.name && data[input.name] !== undefined) input.value = data[input.name];
        });
        
        if (data.fileNames) {
            fileListDiv.innerHTML = '<p style="font-size:0.9rem; color: var(--text-muted-color);">저장된 파일 목록입니다. (파일은 보안상 자동 저장되지 않으므로 필요 시 다시 선택해주세요.)</p>';
            data.fileNames.forEach(name => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `<span>${name}</span>`;
                fileListDiv.appendChild(fileItem);
            });
        }

        const costList = document.getElementById('costList');
        costList.innerHTML = '';
        if (data.otherCosts) data.otherCosts.forEach(item => addListItem(costList, '비용명', 'costname', '금액', 'costval', item.name, item.value));
        const revList = document.getElementById('revList');
        revList.innerHTML = '';
        if (data.revenues) data.revenues.forEach(item => addListItem(revList, '수익명', 'revname', '금액', 'revval', item.name, item.value));
        const ticketList = document.getElementById('ticketList');
        ticketList.innerHTML = '';
        if (data.tickets) data.tickets.forEach(item => addTicketItem(item.type, item.count, item.price));
        mainForm.querySelectorAll('.auto-format').forEach(formatNumberInput);
    };

    const addListItem = (listEl, p1, c1, p2, c2, val1 = '', val2 = '') => {
        const item = document.createElement("div"); item.className = 'dynamic-list-item';
        item.innerHTML = `<input placeholder="${p1}" class="${c1}" value="${val1}" style="flex-grow: 2;"><div class="input-group" style="flex-grow: 1;"><input type="text" inputmode="numeric" placeholder="${p2}" class="${c2} auto-format" value="${val2}"><span class="input-unit">만원</span></div><button type="button" class="del-btn" title="삭제">삭제</button>`;
        listEl.appendChild(item);
    };
    const addTicketItem = (type = '', count = '', price = '') => {
        const item = document.createElement("div"); item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" placeholder="티켓종류" class="ticketType" value="${type}"><input type="text" inputmode="numeric" placeholder="판매수" class="ticketCount auto-format" value="${count}"><div class="input-group"><input type="text" inputmode="numeric" placeholder="가격" class="ticketPrice auto-format" value="${price}"><span class="input-unit">만원</span></div><button type="button" class="del-btn" title="삭제">삭제</button>`;
        ticketList.appendChild(item);
    };

    const calculate = (salesRate = 100) => {
        const MAN_WON = 10000;
        let totalCost = 0, totalRevenue = 0, ticketRevenue = 0;
        let totalTicketCount = 0;
        const ticketDetails = [];
        
        const artistFee = parseFloat(getUnformattedValue(mainForm.elements.artistFee.value)) * MAN_WON;
        const venueFee = parseFloat(getUnformattedValue(mainForm.elements.venueFee.value)) * MAN_WON;
        totalCost += artistFee + venueFee;

        document.querySelectorAll('.costval').forEach(input => totalCost += parseFloat(getUnformattedValue(input.value)) * MAN_WON);
        document.querySelectorAll('.revval').forEach(input => totalRevenue += parseFloat(getUnformattedValue(input.value)) * MAN_WON);
        document.querySelectorAll('.ticket-list .dynamic-list-item').forEach(item => {
            const price = parseFloat(getUnformattedValue(item.querySelector('.ticketPrice').value));
            const count = parseFloat(getUnformattedValue(item.querySelector('.ticketCount').value));
            const type = item.querySelector('.ticketType').value || '미분류 티켓';
            ticketRevenue += price * count * MAN_WON;
            totalTicketCount += count;
            if (price > 0 && count > 0) ticketDetails.push({ type, price, count });
        });
        
        ticketRevenue *= (salesRate / 100);
        totalRevenue += ticketRevenue;
        const averageTicketPrice = totalTicketCount > 0 ? (ticketRevenue / (totalTicketCount * (salesRate/100))) : 0;
        const netProfit = totalRevenue - totalCost;
        const ROI = totalCost > 0 ? ((netProfit / totalCost) * 100).toFixed(2) : 0;
        const BEP = averageTicketPrice > 0 ? Math.ceil(totalCost / averageTicketPrice) : 0;
        const investorShare = Number(document.querySelector('input[name=investorShare]').value || 0);
        const investorProfit = netProfit > 0 ? Math.floor(netProfit * (investorShare / 100)) : 0;
        const ownerProfit = netProfit > 0 ? netProfit - investorProfit : 0;
        
        return { totalCost, totalRevenue, netProfit, ROI, BEP, investorProfit, ownerProfit, investorShare, ticketDetails };
    };

    const displayFinalResults = () => {
        const resultDiv = document.getElementById('result');
        if (!resultDiv) return;

        const resultData = calculate();
        document.getElementById('finalProjectName').textContent = mainForm.elements.projectName.value;
        document.getElementById('finalArtistName').textContent = `아티스트: ${mainForm.elements.artist.value}`;
        document.getElementById('finalProjectOverview').textContent = mainForm.elements.projectOverview.value || '입력된 개요가 없습니다.';
        document.getElementById('finalSpecialNotes').textContent = mainForm.elements.specialNotes.value || '입력된 특이사항이 없습니다.';

        const finalAttachmentsList = document.getElementById('finalAttachmentsList');
        finalAttachmentsList.innerHTML = '';
        const fileNames = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}').fileNames || [];
        if (fileNames.length > 0) {
            fileNames.forEach(name => {
                const li = document.createElement('li');
                li.textContent = `📄 ${name}`;
                finalAttachmentsList.appendChild(li);
            });
        } else {
            finalAttachmentsList.innerHTML = '<li>첨부된 파일이 없습니다.</li>';
        }


        const formatToKrwManwon = (amount) => `KRW ${(amount / 10000).toLocaleString('ko-KR', { maximumFractionDigits: 0 })} 만원`;
        document.getElementById('result-summary').innerHTML = `
            <h3>재무 요약</h3>
            <div>총비용: <b>${formatToKrwManwon(resultData.totalCost)}</b></div>
            <div>총수익: <b>${formatToKrwManwon(resultData.totalRevenue)}</b></div>
            <div>순수익: <b>${formatToKrwManwon(resultData.netProfit)}</b></div>
            <div>ROI: <b>${resultData.ROI}%</b></div>
            <div>BEP (평균): <b>약 ${resultData.BEP.toLocaleString('ko-KR')}매 판매 필요</b></div>
            <hr style="border:0; border-top:1px solid var(--border-color); margin: 12px 0;">
            <div>투자자 예상 수익: <b>${formatToKrwManwon(resultData.investorProfit)}</b> (${resultData.investorShare}%)</div>
            <div>사업주체 예상 수익: <b>${formatToKrwManwon(resultData.ownerProfit)}</b> (${100 - resultData.investorShare}%)</div>
        `;
        runSimulation();
        updateBepTable(resultData.totalCost, resultData.ticketDetails);
        resultDiv.classList.add('visible');
    };

    // --- Advanced Analytics ---
    const salesRateSlider = document.getElementById('salesRateSlider');
    const salesRateLabel = document.getElementById('salesRateLabel');
    const simulationResultDiv = document.getElementById('simulationResult');
    const bepTable = document.getElementById('bepTable');

    const runSimulation = () => {
        const salesRate = parseInt(salesRateSlider.value);
        salesRateLabel.textContent = `${salesRate}%`;
        const resultData = calculate(salesRate);
        const formatToKrwManwon = (amount) => `KRW ${(amount / 10000).toLocaleString('ko-KR', { maximumFractionDigits: 0 })} 만원`;
        simulationResultDiv.innerHTML = `판매율 ${salesRate}% 적용 시, 예상 순수익: <b>${formatToKrwManwon(resultData.netProfit)}</b>, ROI: <b>${resultData.ROI}%</b>`;
    };

    const updateBepTable = (totalCost, ticketDetails) => {
        let tableHTML = '<thead><tr><th>티켓 등급</th><th>단가 (만원)</th><th>BEP 달성 판매량</th></tr></thead><tbody>';
        if (ticketDetails.length === 0) {
            tableHTML += '<tr><td colspan="3">티켓 정보를 입력하세요.</td></tr>';
        } else {
            ticketDetails.forEach(ticket => {
                const bepForTicket = ticket.price > 0 ? Math.ceil((totalCost / 10000) / ticket.price) : 'N/A';
                tableHTML += `<tr><td>${ticket.type}</td><td>${ticket.price.toLocaleString('en-US')}</td><td>${bepForTicket.toLocaleString('en-US')} 매</td></tr>`;
            });
        }
        tableHTML += '</tbody>';
        bepTable.innerHTML = tableHTML;
    };

    salesRateSlider.addEventListener('input', runSimulation);

     // --- Gemini API Integration ---
    const callGemini = async (prompt) => {
        const apiKey = ""; // API 키는 비워두세요.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API 요청 실패: ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            }
            return "AI로부터 응답을 받지 못했습니다.";
        } catch (error) {
            console.error("Gemini API 호출 중 오류:", error);
            return "AI 호출 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
        }
    };

    document.getElementById('generateOverviewBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = '생성 중...';
        btn.disabled = true;

        const projectName = mainForm.elements.projectName.value || '미정';
        const artist = mainForm.elements.artist.value || '미정';
        
        const prompt = `아래 정보를 바탕으로, 엔터테인먼트 투자자에게 매력적으로 보일 수 있는 '프로젝트 개요'와 '특이사항 및 기대효과'를 각각 2-3문장의 전문가 톤으로 작성해줘. 결과는 아래 형식을 반드시 지켜서 구분해줘:

[개요]
(여기에 프로젝트 개요 작성)

[특이사항]
(여기에 특이사항 및 기대효과 작성)

---
- 사업명: ${projectName}
- 아티스트: ${artist}
`;
        const responseText = await callGemini(prompt);
        
        const overviewMatch = responseText.match(/\[개요\]\s*([\s\S]*?)\s*\[특이사항\]/);
        const notesMatch = responseText.match(/\[특이사항\]\s*([\s\S]*)/);

        if (overviewMatch && overviewMatch[1]) {
            mainForm.elements.projectOverview.value = overviewMatch[1].trim();
        }
        if (notesMatch && notesMatch[1]) {
            mainForm.elements.specialNotes.value = notesMatch[1].trim();
        }

        btn.textContent = '✨ AI로 개요 자동 작성';
        btn.disabled = false;
        saveData(); // Save generated text
    });

    document.getElementById('analyzeRiskBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = '분석 중...';
        btn.disabled = true;
        const riskResultDiv = document.getElementById('riskAnalysisResult');
        riskResultDiv.textContent = 'AI가 리스크를 분석하고 있습니다...';

        const resultData = calculate();
        const ticketInfo = resultData.ticketDetails.map(t => `${t.type}: ${t.count}석 x ${t.price}만원`).join(', ');

        const prompt = `당신은 전문 엔터테인먼트 투자 분석가입니다. 아래의 공연 투자 제안서 데이터를 바탕으로, 발생할 수 있는 잠재적 리스크 3가지와 그에 대한 완화 방안을 전문가의 관점에서 분석해주세요. 결과는箇条書き(bullet points) 형식으로 명확하게 제시해주세요.

- 사업명: ${mainForm.elements.projectName.value}
- 아티스트: ${mainForm.elements.artist.value}
- 총 비용: ${ (resultData.totalCost / 10000).toLocaleString() }만원
- 예상 총 수익: ${ (resultData.totalRevenue / 10000).toLocaleString() }만원
- 티켓 정보: ${ticketInfo}
- 순수익: ${ (resultData.netProfit / 10000).toLocaleString() }만원
`;
        const analysis = await callGemini(prompt);
        riskResultDiv.textContent = analysis;

        btn.textContent = '✨ AI로 리스크 분석하기';
        btn.disabled = false;
    });

    document.getElementById('generateCostItemsBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = '추천 중...';
        btn.disabled = true;
        const prompt = `엔터테인먼트 콘서트나 팬미팅에서 일반적으로 발생하는 주요 비용 항목 5가지를 리스트업해줘. 아티스트 개런티와 베뉴 비용은 이미 있으니 제외하고, "항목명" 형식으로 쉼표로 구분해서 한 줄로만 답변해줘. 예: 무대 제작비,음향/조명 장비 렌탈,경호 및 안전,홍보 마케팅,스태프 인건비`;
        const response = await callGemini(prompt);
        response.split(',').forEach(item => {
            if (item.trim()) {
                addListItem(document.getElementById('costList'), '기타 비용', 'costname', '금액', 'costval', item.trim());
            }
        });
        btn.textContent = '✨ AI 예상 비용 추천';
        btn.disabled = false;
        saveData();
    });

    document.getElementById('generateRevenueItemsBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = '추천 중...';
        btn.disabled = true;
        const prompt = `엔터테인먼트 콘서트나 팬미팅에서 티켓 판매 외에 발생할 수 있는 추가 수익원 아이디어 3가지를 리스트업해줘. "항목명" 형식으로 쉼표로 구분해서 한 줄로만 답변해줘. 예: 공식 MD 상품 판매,온라인 스트리밍 유료 중계,현장 광고 및 스폰서십`;
        const response = await callGemini(prompt);
        response.split(',').forEach(item => {
            if (item.trim()) {
                addListItem(document.getElementById('revList'), '기타 수익', 'revname', '금액', 'revval', item.trim());
            }
        });
        btn.textContent = '✨ AI 추가 수익원 추천';
        btn.disabled = false;
        saveData();
    });

    document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = '생성 중...';
        btn.disabled = true;
        const summaryP = document.getElementById('aiSummary');
        summaryP.textContent = 'AI가 제안서를 요약하고 있습니다...';

        const resultData = calculate();
        const prompt = `아래의 모든 데이터를 종합하여, 투자자에게 보내는 투자 제안서의 핵심 요약(Executive Summary)을 3~4문장의 전문적인 톤으로 작성해줘. 프로젝트의 매력과 높은 수익성을 강조해줘.

- 프로젝트명: ${mainForm.elements.projectName.value}
- 아티스트: ${mainForm.elements.artist.value}
- 프로젝트 개요: ${mainForm.elements.projectOverview.value}
- 총 투자 요청 금액: ${mainForm.elements.requestAmount.value}만원
- 예상 총 수익: ${(resultData.totalRevenue / 10000).toLocaleString()}만원
- 예상 순수익: ${(resultData.netProfit / 10000).toLocaleString()}만원
- 예상 ROI: ${resultData.ROI}%
`;
        const summary = await callGemini(prompt);
        summaryP.textContent = summary;
        btn.textContent = '✨ AI로 요약 생성하기';
        btn.disabled = false;
    });


    // --- Init & Event Listeners ---
    const init = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            loadData(JSON.parse(savedData));
        } else {
            addListItem(document.getElementById('costList'), '기타 비용', 'costname', '금액', 'costval');
            addListItem(document.getElementById('revList'), '기타 수익', 'revname', '금액', 'revval');
            addTicketItem();
        }
    };
    init();

    mainForm.addEventListener('input', saveData);
    document.getElementById('addCostBtn').addEventListener('click', () => { addListItem(document.getElementById('costList'), '기타 비용', 'costname', '금액', 'costval'); saveData(); });
    document.getElementById('addRevBtn').addEventListener('click', () => { addListItem(document.getElementById('revList'), '기타 수익', 'revname', '금액', 'revval'); saveData(); });
    document.getElementById('addTicketBtn').addEventListener('click', () => { addTicketItem(); saveData(); });
    document.getElementById('savePdfBtn').addEventListener('click', async () => {
        const btn = document.getElementById('savePdfBtn');
        btn.innerText = "PDF 생성중...";
        btn.disabled = true;
        
        const card = document.getElementById('main-card');
        card.classList.add('pdf-export-mode');

        displayFinalResults();

        try {
            await new Promise(resolve => setTimeout(resolve, 100));

            const pdfContent = document.getElementById('pdf-content');
            const canvas = await html2canvas(pdfContent, { 
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true
            });

            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            const projectName = document.querySelector('input[name="projectName"]').value || '투자제안서';
            pdf.save(`${projectName}.pdf`);
        } catch (error) {
            console.error("PDF 생성 중 오류 발생:", error);
            alert("PDF를 생성하는 중에 오류가 발생했습니다. 다시 시도해주세요.");
        } finally {
            card.classList.remove('pdf-export-mode');
            btn.innerText = "PDF로 저장";
            btn.disabled = false;
        }
    });
    
    const submitBtn = document.getElementById('submitBtn');
    const submissionSuccessScreen = document.getElementById('submission-success');
    const submissionMessage = document.getElementById('submission-message');
    const startNewBtn = document.getElementById('startNewBtn');
    const progressBar = document.querySelector('.progress-bar');

    submitBtn.addEventListener('click', () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const timestamp = `${year}년 ${month}월 ${day}일 ${hours}시 ${minutes}분 ${seconds}초`;
        submissionMessage.textContent = `약식 투자제안서는, ${timestamp}에 정상적으로 제출되었습니다.`;

        mainForm.style.display = 'none';
        progressBar.style.display = 'none';
        submissionSuccessScreen.style.display = 'block';
    });

    startNewBtn.addEventListener('click', () => {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload();
    });

    [document.getElementById('costList'), document.getElementById('revList'), document.getElementById('ticketList')].forEach(list => {
        list.addEventListener('click', function(e) {
            if (e.target.classList.contains('del-btn')) {
                e.target.parentElement.remove();
                saveData();
            }
        });
    });
});
</script>
</body>
</html>
