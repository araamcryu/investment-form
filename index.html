<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>UJIN ENTERTAINMENT ì „ìš© íˆ¬ì ì œì•ˆì„œ ìƒì„±ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color-start: #1D2B64;
            --bg-color-end: #000000;
            --card-bg-color: rgba(22, 24, 30, 0.6);
            --input-bg-color: rgba(10, 12, 18, 0.7);
            --primary-color: #8A3FFC; /* Vibrant Violet */
            --primary-light-color: #BE95FF;
            --text-color: #F8F9FA;
            --text-muted-color: #ADB5BD;
            --border-color: rgba(255, 255, 255, 0.15);
            --error-color: #ff6384;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            margin: 0;
            background: linear-gradient(-45deg, #1D2B64, #F8CDDA, #1D2B64, #000000);
            background-size: 400% 400%;
            animation: gradientAnimation 25s ease infinite;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            color: var(--text-color); min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; overflow-x: hidden;
        }
        .main-wrap { width: 100%; max-width: 900px; }
        .title {
            font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 2rem;
            color: var(--text-color); text-shadow: 0 0 20px var(--primary-light-color), var(--text-shadow);
        }
        .glass-card {
            background: var(--card-bg-color); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 25px; border: 1px solid var(--border-color); padding: 35px;
            box-shadow: 0 16px 45px 0 var(--shadow-color);
        }
        .progress-bar {
            display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative;
            transition: opacity 0.5s ease;
        }
        .progress-bar::before {
            content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%);
            height: 4px; width: 100%; background: var(--input-bg-color); border-radius: 2px; z-index: 1;
        }
        .progress-bar .progress {
            position: absolute; top: 50%; left: 0; transform: translateY(-50%);
            height: 4px; background: var(--primary-color); z-index: 2; border-radius: 2px;
            width: 0%; transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .progress-step {
            width: 38px; height: 38px; background: var(--input-bg-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-weight: 600;
            border: 2px solid var(--border-color); z-index: 3; transition: all 0.4s ease;
        }
        .progress-step.active {
            background: var(--primary-color); border-color: var(--primary-light-color);
            color: #fff; transform: scale(1.15); box-shadow: 0 0 15px var(--primary-color);
        }
        .form-step { display: none; animation: fadeIn 0.6s ease-out; }
        .form-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-section h2 {
            font-size: 1.6rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 1rem;
            color: var(--primary-light-color); text-shadow: var(--text-shadow);
            border-bottom: 1px solid var(--border-color);
        }
        .error-message { color: var(--error-color); margin-bottom: 1rem; display: none; font-size: 0.9rem; font-weight: 500; }
        .form-row { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
        .form-label { min-width: 140px; font-size: 1rem; font-weight: 500; color: var(--text-muted-color); text-shadow: var(--text-shadow); }
        input, select, textarea {
            font-family: inherit; font-size: 1rem; border-radius: 10px; border: 1px solid var(--border-color);
            padding: 13px 16px; background: var(--input-bg-color); color: var(--text-color);
            transition: all 0.3s ease; flex-grow: 1;
        }
        textarea { min-height: 80px; resize: vertical; }
        input:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(138, 63, 252, 0.3);
        }
        .input-group {
            display: flex; align-items: center; flex-grow: 1; background: var(--input-bg-color);
            border-radius: 10px; border: 1px solid var(--border-color); transition: all 0.3s ease;
        }
        .input-group input { border: none; background: transparent; }
        .input-group input:focus { box-shadow: none; }
        .input-group:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(138, 63, 252, 0.3); }
        .input-unit { padding-right: 16px; color: var(--text-muted-color); font-weight: 500; }
        .btn {
            background: var(--primary-color); color: #fff; border: none; padding: 13px 26px;
            border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(138, 63, 252, 0.2);
        }
        .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 8px 25px rgba(138, 63, 252, 0.3); }
        .btn:disabled { background: var(--text-muted-color); cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .btn.btn-secondary { background: var(--input-bg-color); box-shadow: none; border: 1px solid var(--border-color); }
        .btn.btn-secondary:hover { background: var(--primary-color); border-color: var(--primary-color); }
        .btn.add-item-btn { width: auto; flex-grow: 0; }
        .dynamic-list-container { padding: 1rem 0; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .dynamic-list-container:last-of-type { border-bottom: none; }
        .dynamic-list-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .del-btn {
            background: rgba(255, 99, 132, 0.2); border: 1px solid rgba(255, 99, 132, 0.5);
            color: #ff6384; padding: 10px 16px; border-radius: 8px; font-size: 0.8rem; flex-shrink: 0;
        }
        .del-btn:hover { background: #ff6384; color: #fff; }
        
        /* Bento Grid Layout */
        #bento-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto;
        }
        .bento-item {
            background: var(--input-bg-color); border-radius: 12px; padding: 20px;
            border: 1px solid var(--border-color); font-size: 1.05rem;
        }
        .bento-item h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary-light-color); }
        .bento-item-1 { grid-column: span 3; } /* Project Name */
        .bento-item-2 { grid-column: span 2; grid-row: span 2; } /* Overview */
        .bento-item-3 { grid-column: span 1; } /* Attachments */
        .bento-item-4 { grid-column: span 1; } /* Summary */
        .bento-item-5 { grid-column: span 3; } /* Advanced Analytics */
        .bento-item-6 { grid-column: span 3; } /* AI Risk Analysis */
        .bento-item-7 { grid-column: span 3; } /* AI Summary */
        
        .result-card b { color: var(--primary-light-color); font-weight: 600; }
        .slider-row { display: flex; align-items: center; gap: 1rem; }
        .slider-row input[type=range] { flex-grow: 1; }
        details summary { font-weight: 600; cursor: pointer; }
        .bep-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        .bep-table th, .bep-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #fileList { margin-top: 10px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-radius: 5px; background-color: var(--bg-color); margin-bottom: 5px; }
        .pdf-export-mode .glass-card { background: #ffffff !important; color: #000000 !important; --text-color: #000000; --text-muted-color: #444444; --primary-light-color: #0056b3; --input-bg-color: #f8f9fa; --border-color: #dee2e6; }
        .pdf-export-mode h1, .pdf-export-mode h2, .pdf-export-mode h3, .pdf-export-mode .form-label, .pdf-export-mode .input-unit, .pdf-export-mode .bento-item { text-shadow: none !important; }
        
        #submission-success { text-align: center; }
        #submission-success h2 { color: var(--primary-light-color); font-size: 2.2rem; margin-bottom: 1rem; }
        #submission-success p { font-size: 1.1rem; line-height: 1.7; color: var(--text-muted-color); margin-bottom: 2.5rem; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .title { font-size: 2rem; }
            .glass-card { padding: 20px; }
            .form-row { flex-direction: column; align-items: flex-start; gap: 8px; }
            .form-label { min-width: 100%; margin-bottom: 4px; }
            .btn-group { flex-direction: column; gap: 1rem; }
            #bento-grid { grid-template-columns: 1fr; }
            .bento-item-1, .bento-item-2, .bento-item-3, .bento-item-4, .bento-item-5, .bento-item-6, .bento-item-7 { grid-column: span 1; grid-row: span 1; }
            .dynamic-list-item { flex-direction: column; align-items: stretch; }
            .dynamic-list-item > * { width: 100% !important; }
            .dynamic-list-item .del-btn { margin-top: 8px; }
        }
    </style>
</head>
<body>
<div class="main-wrap">
    <h1 class="title">UJIN ENTERTAINMENT ì „ìš©</h1>
    <div class="glass-card" id="main-card">
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
            <div class="progress-step active" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
        </div>
        <form id="mainForm">
            <!-- Step 1: ê¸°ë³¸ ì •ë³´ -->
            <div class="form-step active" id="step-1">
                <div class="form-section">
                    <h2>1ë‹¨ê³„: ì‚¬ì—… ê°œìš”</h2>
                    <div class="error-message"></div>
                    <div class="form-row"><span class="form-label">ì‚¬ì—…ëª…</span><input name="projectName" required></div>
                    <div class="form-row"><span class="form-label">ì•„í‹°ìŠ¤íŠ¸ëª…</span><input name="artist" required></div>
                    <div class="form-row"><span class="form-label">í”„ë¡œì íŠ¸ ê°œìš”</span><textarea name="projectOverview" placeholder="í”„ë¡œì íŠ¸ì˜ ëª©í‘œ, ë¹„ì „, í•µì‹¬ ë‚´ìš©ì„ ìš”ì•½í•©ë‹ˆë‹¤."></textarea></div>
                    <div class="form-row"><span class="form-label">íŠ¹ì´ì‚¬í•­ ë° ê¸°ëŒ€íš¨ê³¼</span><textarea name="specialNotes" placeholder="ë³¸ ì‚¬ì—…ì˜ ì°¨ë³„ì , ê°•ì , ì˜ˆìƒë˜ëŠ” ê¸ì •ì  íš¨ê³¼ë¥¼ ê¸°ìˆ í•©ë‹ˆë‹¤."></textarea></div>
                    <div class="form-row">
                        <span class="form-label"></span>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateOverviewBtn">âœ¨ AIë¡œ ê°œìš” ìë™ ì‘ì„±</button>
                    </div>
                    <div class="form-row"><span class="form-label">ì²¨ë¶€ íŒŒì¼</span>
                        <div style="flex-grow: 1;">
                            <input type="file" id="fileUpload" multiple style="display:none;">
                            <button type="button" class="btn btn-secondary add-item-btn" onclick="document.getElementById('fileUpload').click();">íŒŒì¼ ì„ íƒ</button>
                            <div id="fileList"></div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <span></span>
                    <button type="button" class="btn" data-next>ë‹¤ìŒ ë‹¨ê³„ &rarr;</button>
                </div>
            </div>

            <!-- Step 2: ë¹„ìš© ë° ìˆ˜ìµ -->
            <div class="form-step" id="step-2">
                <div class="form-section">
                    <h2>2ë‹¨ê³„: ì¬ë¬´ ì •ë³´</h2>
                    <div class="error-message"></div>
                    <div class="form-row"><span class="form-label">ì½˜ì„œíŠ¸ì¥ ìœ„ì¹˜</span><input name="venue" required></div>
                    <div class="form-row"><span class="form-label">ì´ ì¢Œì„ìˆ˜</span><input type="text" inputmode="numeric" name="seatCount" class="auto-format" required></div>
                    <div class="form-row"><span class="form-label">ì½˜ì„œíŠ¸ì¼ì •</span><input type="date" name="showStart"> ~ <input type="date" name="showEnd"></div>
                    <div class="form-row">
                        <span class="form-label">íˆ¬ììš”ì²­ê¸ˆì•¡</span>
                        <div class="input-group"><input type="text" inputmode="numeric" name="requestAmount" class="auto-format" required placeholder="ì˜ˆ: 10,000"><span class="input-unit">ë§Œì›</span></div>
                    </div>
                    <div class="form-row">
                        <span class="form-label">ìˆ˜ìµë°°ë¶„ (íˆ¬ìì)</span>
                        <div class="input-group"><input type="number" name="investorShare" min="0" max="100" value="70" required><span class="input-unit">%</span></div>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">í‹°ì¼“ ì •ë³´</h3>
                        <div class="ticket-list" id="ticketList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addTicketBtn" style="margin-top: 1rem;">+ í‹°ì¼“ì¶”ê°€</button>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">ë¹„ìš© ë‚´ì—­</h3>
                        <div class="form-row">
                            <span class="form-label">ì•„í‹°ìŠ¤íŠ¸ ê°œëŸ°í‹°</span>
                            <div class="input-group"><input type="text" inputmode="numeric" name="artistFee" class="auto-format" required placeholder="ê°€ì¥ í° ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” ë¹„ìš©"><span class="input-unit">ë§Œì›</span></div>
                        </div>
                        <div class="form-row">
                            <span class="form-label">ë² ë‰´ (ëŒ€ê´€) ë¹„ìš©</span>
                            <div class="input-group"><input type="text" inputmode="numeric" name="venueFee" class="auto-format" required placeholder="ê³µì—°ì¥ ëŒ€ê´€ë£Œ ë“±"><span class="input-unit">ë§Œì›</span></div>
                        </div>
                        <div class="cost-list" id="costList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addCostBtn" style="margin-top: 1rem;">+ ê¸°íƒ€ ë¹„ìš©ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateCostItemsBtn" style="margin-top: 1rem; margin-left: 10px;">âœ¨ AI ì˜ˆìƒ ë¹„ìš© ì¶”ì²œ</button>
                    </div>
                    
                    <div class="dynamic-list-container">
                        <h3 style="font-weight: 500; margin-bottom: 0.5rem;">ê¸°íƒ€ ìˆ˜ìµ ë‚´ì—­</h3>
                        <div class="rev-list" id="revList"></div>
                        <button type="button" class="btn btn-secondary add-item-btn" id="addRevBtn" style="margin-top: 1rem;">+ ìˆ˜ìµì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary add-item-btn" id="generateRevenueItemsBtn" style="margin-top: 1rem; margin-left: 10px;">âœ¨ AI ì¶”ê°€ ìˆ˜ìµì› ì¶”ì²œ</button>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" data-prev>&larr; ì´ì „ ë‹¨ê³„</button>
                    <button type="button" class="btn" data-next>ê²°ê³¼ í™•ì¸ &rarr;</button>
                </div>
            </div>

            <!-- Step 3: ê²°ê³¼ í™•ì¸ -->
            <div class="form-step" id="step-3">
                <div id="result">
                    <div id="pdf-content">
                        <div id="bento-grid">
                            <div class="bento-item bento-item-1">
                                <h2 id="finalProjectName" style="border:none; padding-bottom: 0; margin-bottom: 0.5rem; text-align: center;"></h2>
                                <p id="finalArtistName" style="margin:0; color: var(--text-muted-color); text-align: center; margin-top: -0.5rem; margin-bottom: 1rem;"></p>
                            </div>
                            <div class="bento-item bento-item-2">
                                <h3>í”„ë¡œì íŠ¸ ê°œìš”</h3>
                                <p id="finalProjectOverview"></p>
                                <h3>íŠ¹ì´ì‚¬í•­ ë° ê¸°ëŒ€íš¨ê³¼</h3>
                                <p id="finalSpecialNotes"></p>
                            </div>
                             <div class="bento-item bento-item-3">
                                <h3>ì²¨ë¶€ íŒŒì¼ ëª©ë¡</h3>
                                <ul id="finalAttachmentsList" style="list-style-type: none; padding-left: 0;"></ul>
                            </div>
                            <div class="bento-item bento-item-4 result-card" id="result-summary"></div>
                             <div class="bento-item bento-item-7">
                                <h3>AI íˆ¬ì ì œì•ˆ ìš”ì•½</h3>
                                <button type="button" class="btn btn-secondary" id="generateSummaryBtn">âœ¨ AIë¡œ ìš”ì•½ ìƒì„±í•˜ê¸°</button>
                                <p id="aiSummary" style="margin-top: 1rem; white-space: pre-wrap;"></p>
                            </div>
                            <div class="bento-item bento-item-5">
                                <details>
                                    <summary>ê³ ê¸‰ ë¶„ì„ ë³´ê¸°</summary>
                                    <div id="advanced-analytics" style="margin-top:1rem;">
                                        <h4>ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜</h4>
                                        <div class="slider-row">
                                            <label>í‹°ì¼“ íŒë§¤ìœ¨:</label>
                                            <input type="range" id="salesRateSlider" min="50" max="120" value="100">
                                            <span id="salesRateLabel">100%</span>
                                        </div>
                                        <div id="simulationResult"></div>
                                        <h4 style="margin-top: 1.5rem;">ë“±ê¸‰ë³„ ì†ìµë¶„ê¸°ì (BEP) ë¶„ì„</h4>
                                        <table class="bep-table" id="bepTable"></table>
                                    </div>
                                </details>
                            </div>
                             <div class="bento-item bento-item-6">
                                <h3>AI ë¦¬ìŠ¤í¬ ë¶„ì„</h3>
                                <button type="button" class="btn btn-secondary" id="analyzeRiskBtn">âœ¨ AIë¡œ ë¦¬ìŠ¤í¬ ë¶„ì„í•˜ê¸°</button>
                                <div id="riskAnalysisResult" style="margin-top: 1rem; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" data-prev>&larr; ì´ì „ ë‹¨ê³„</button>
                    <button type="button" class="btn" id="savePdfBtn">PDFë¡œ ì €ì¥</button>
                </div>
                 <button type="button" class="btn" id="submitBtn" style="margin-top: 1rem; width: 100%;">ì œì¶œí•˜ê¸°</button>
            </div>
        </form>
        <div id="submission-success" style="display: none; animation: fadeIn 0.6s ease-out;">
            <h2>ì œì¶œ ì™„ë£Œ</h2>
            <p id="submission-message"></p>
            <button type="button" class="btn" id="startNewBtn">ìƒˆ ì œì•ˆì„œ ì‘ì„±í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mainForm = document.getElementById('mainForm');
    
    // --- ìë™ í¬ë§·íŒ… í•¨ìˆ˜ ---
    const formatNumberInput = (input) => {
        if (!input) return;
        let value = input.value.replace(/,/g, '');
        if (isNaN(value) || value.trim() === '') {
            input.value = '';
        } else {
            input.value = parseInt(value, 10).toLocaleString('en-US');
        }
    };
    const getUnformattedValue = (value) => {
        return value.replace(/,/g, '') || '0';
    };
    mainForm.addEventListener('input', (e) => {
        if (e.target.classList.contains('auto-format')) {
            formatNumberInput(e.target);
        }
    });

    // --- Navigation ---
    const prevBtns = document.querySelectorAll('[data-prev]');
    const nextBtns = document.querySelectorAll('[data-next]');
    const progress = document.getElementById('progress');
    const steps = document.querySelectorAll('.form-step');
    const progressSteps = document.querySelectorAll('.progress-step');
    let currentStep = 1;

    nextBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                updateFormSteps();
            }
        });
    });
    prevBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            currentStep--;
            updateFormSteps();
        });
    });

    const updateFormSteps = () => {
        steps.forEach(step => step.classList.remove('active'));
        const currentStepEl = document.querySelector(`#step-${currentStep}`);
        if (currentStepEl) {
            currentStepEl.classList.add('active');
        }
        
        progressSteps.forEach((step, idx) => {
            step.classList.toggle('active', idx < currentStep);
        });
        
        progress.style.width = `${((currentStep - 1) / (steps.length - 1)) * 100}%`;
        
        if (currentStep === 3) {
            displayFinalResults();
        }
    };
    
    const validateStep = (stepNumber) => {
        const currentStepEl = document.getElementById(`step-${stepNumber}`);
        const errorDiv = currentStepEl.querySelector('.error-message');
        const inputs = currentStepEl.querySelectorAll('input[required], textarea[required]');
        let isValid = true;
        errorDiv.style.display = 'none';
        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.style.borderColor = 'var(--error-color)';
                isValid = false;
            } else {
                input.style.borderColor = 'var(--border-color)';
            }
        });
        if (!isValid) {
            errorDiv.textContent = 'í˜„ì¬ ë‹¨ê³„ì˜ ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            errorDiv.style.display = 'block';
        }
        return isValid;
    };
    
    mainForm.addEventListener('input', (e) => {
        const target = e.target;
        if ((target.tagName === 'INPUT' && target.hasAttribute('required')) || (target.tagName === 'TEXTAREA' && target.hasAttribute('required'))) {
            if (target.value.trim()) {
                target.style.borderColor = 'var(--border-color)';
                const errorDiv = target.closest('.form-step').querySelector('.error-message');
                if (errorDiv) errorDiv.style.display = 'none';
            }
        }
    });

    // --- File Upload ---
    const fileUpload = document.getElementById('fileUpload');
    const fileListDiv = document.getElementById('fileList');
    let attachedFiles = [];

    fileUpload.addEventListener('change', function() {
        attachedFiles = Array.from(this.files);
        updateFileListUI();
        saveData();
    });

    function updateFileListUI() {
        fileListDiv.innerHTML = '';
        attachedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `<span>${file.name}</span><button type="button" class="del-btn" data-index="${index}">ì‚­ì œ</button>`;
            fileListDiv.appendChild(fileItem);
        });
    }

    fileListDiv.addEventListener('click', function(e) {
        if (e.target.classList.contains('del-btn')) {
            const index = parseInt(e.target.dataset.index, 10);
            attachedFiles.splice(index, 1);
            updateFileListUI();
            saveData();
        }
    });

    // --- Data, Calc ---
    const STORAGE_KEY = 'investmentProposalData_v12_final';

    const saveData = () => {
        const data = {};
        const inputs = mainForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type !== 'file' && input.name) data[input.name] = input.value;
        });
        data.fileNames = attachedFiles.map(f => f.name);
        data.otherCosts = Array.from(document.getElementById('costList').querySelectorAll('.dynamic-list-item')).map(item => ({ name: item.querySelector('.costname').value, value: item.querySelector('.costval').value }));
        data.revenues = Array.from(document.getElementById('revList').querySelectorAll('.dynamic-list-item')).map(item => ({ name: item.querySelector('.revname').value, value: item.querySelector('.revval').value }));
        data.tickets = Array.from(document.getElementById('ticketList').querySelectorAll('.dynamic-list-item')).map(item => ({ type: item.querySelector('.ticketType').value, count: item.querySelector('.ticketCount').value, price: item.querySelector('.ticketPrice').value }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    };

    const loadData = (data) => {
        const inputs = mainForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.type !== 'file' && input.name && data[input.name] !== undefined) input.value = data[input.name];
        });
        
        if (data.fileNames) {
            fileListDiv.innerHTML = '<p style="font-size:0.9rem; color: var(--text-muted-color);">ì €ì¥ëœ íŒŒì¼ ëª©ë¡ì…ë‹ˆë‹¤. (íŒŒì¼ì€ ë³´ì•ˆìƒ ìë™ ì €ì¥ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ í•„ìš” ì‹œ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.)</p>';
            data.fileNames.forEach(name => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `<span>${name}</span>`;
                fileListDiv.appendChild(fileItem);
            });
        }

        const costList = document.getElementById('costList');
        costList.innerHTML = '';
        if (data.otherCosts) data.otherCosts.forEach(item => addListItem(costList, 'ë¹„ìš©ëª…', 'costname', 'ê¸ˆì•¡', 'costval', item.name, item.value));
        const revList = document.getElementById('revList');
        revList.innerHTML = '';
        if (data.revenues) data.revenues.forEach(item => addListItem(revList, 'ìˆ˜ìµëª…', 'revname', 'ê¸ˆì•¡', 'revval', item.name, item.value));
        const ticketList = document.getElementById('ticketList');
        ticketList.innerHTML = '';
        if (data.tickets) data.tickets.forEach(item => addTicketItem(item.type, item.count, item.price));
        mainForm.querySelectorAll('.auto-format').forEach(formatNumberInput);
    };

    const addListItem = (listEl, p1, c1, p2, c2, val1 = '', val2 = '') => {
        const item = document.createElement("div"); item.className = 'dynamic-list-item';
        item.innerHTML = `<input placeholder="${p1}" class="${c1}" value="${val1}" style="flex-grow: 2;"><div class="input-group" style="flex-grow: 1;"><input type="text" inputmode="numeric" placeholder="${p2}" class="${c2} auto-format" value="${val2}"><span class="input-unit">ë§Œì›</span></div><button type="button" class="del-btn" title="ì‚­ì œ">ì‚­ì œ</button>`;
        listEl.appendChild(item);
    };
    const addTicketItem = (type = '', count = '', price = '') => {
        const item = document.createElement("div"); item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" placeholder="í‹°ì¼“ì¢…ë¥˜" class="ticketType" value="${type}"><input type="text" inputmode="numeric" placeholder="íŒë§¤ìˆ˜" class="ticketCount auto-format" value="${count}"><div class="input-group"><input type="text" inputmode="numeric" placeholder="ê°€ê²©" class="ticketPrice auto-format" value="${price}"><span class="input-unit">ë§Œì›</span></div><button type="button" class="del-btn" title="ì‚­ì œ">ì‚­ì œ</button>`;
        ticketList.appendChild(item);
    };

    const calculate = (salesRate = 100) => {
        const MAN_WON = 10000;
        let totalCost = 0, totalRevenue = 0, ticketRevenue = 0;
        let totalTicketCount = 0;
        const ticketDetails = [];
        
        const artistFee = parseFloat(getUnformattedValue(mainForm.elements.artistFee.value)) * MAN_WON;
        const venueFee = parseFloat(getUnformattedValue(mainForm.elements.venueFee.value)) * MAN_WON;
        totalCost += artistFee + venueFee;

        document.querySelectorAll('.costval').forEach(input => totalCost += parseFloat(getUnformattedValue(input.value)) * MAN_WON);
        document.querySelectorAll('.revval').forEach(input => totalRevenue += parseFloat(getUnformattedValue(input.value)) * MAN_WON);
        document.querySelectorAll('.ticket-list .dynamic-list-item').forEach(item => {
            const price = parseFloat(getUnformattedValue(item.querySelector('.ticketPrice').value));
            const count = parseFloat(getUnformattedValue(item.querySelector('.ticketCount').value));
            const type = item.querySelector('.ticketType').value || 'ë¯¸ë¶„ë¥˜ í‹°ì¼“';
            ticketRevenue += price * count * MAN_WON;
            totalTicketCount += count;
            if (price > 0 && count > 0) ticketDetails.push({ type, price, count });
        });
        
        ticketRevenue *= (salesRate / 100);
        totalRevenue += ticketRevenue;
        const averageTicketPrice = totalTicketCount > 0 ? (ticketRevenue / (totalTicketCount * (salesRate/100))) : 0;
        const netProfit = totalRevenue - totalCost;
        const ROI = totalCost > 0 ? ((netProfit / totalCost) * 100).toFixed(2) : 0;
        const BEP = averageTicketPrice > 0 ? Math.ceil(totalCost / averageTicketPrice) : 0;
        const investorShare = Number(document.querySelector('input[name=investorShare]').value || 0);
        const investorProfit = netProfit > 0 ? Math.floor(netProfit * (investorShare / 100)) : 0;
        const ownerProfit = netProfit > 0 ? netProfit - investorProfit : 0;
        
        return { totalCost, totalRevenue, netProfit, ROI, BEP, investorProfit, ownerProfit, investorShare, ticketDetails };
    };

    const displayFinalResults = () => {
        const resultDiv = document.getElementById('result');
        if (!resultDiv) return;

        const resultData = calculate();
        document.getElementById('finalProjectName').textContent = mainForm.elements.projectName.value;
        document.getElementById('finalArtistName').textContent = `ì•„í‹°ìŠ¤íŠ¸: ${mainForm.elements.artist.value}`;
        document.getElementById('finalProjectOverview').textContent = mainForm.elements.projectOverview.value || 'ì…ë ¥ëœ ê°œìš”ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.getElementById('finalSpecialNotes').textContent = mainForm.elements.specialNotes.value || 'ì…ë ¥ëœ íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';

        const finalAttachmentsList = document.getElementById('finalAttachmentsList');
        finalAttachmentsList.innerHTML = '';
        const fileNames = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}').fileNames || [];
        if (fileNames.length > 0) {
            fileNames.forEach(name => {
                const li = document.createElement('li');
                li.textContent = `ğŸ“„ ${name}`;
                finalAttachmentsList.appendChild(li);
            });
        } else {
            finalAttachmentsList.innerHTML = '<li>ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        }


        const formatToKrwManwon = (amount) => `KRW ${(amount / 10000).toLocaleString('ko-KR', { maximumFractionDigits: 0 })} ë§Œì›`;
        document.getElementById('result-summary').innerHTML = `
            <h3>ì¬ë¬´ ìš”ì•½</h3>
            <div>ì´ë¹„ìš©: <b>${formatToKrwManwon(resultData.totalCost)}</b></div>
            <div>ì´ìˆ˜ìµ: <b>${formatToKrwManwon(resultData.totalRevenue)}</b></div>
            <div>ìˆœìˆ˜ìµ: <b>${formatToKrwManwon(resultData.netProfit)}</b></div>
            <div>ROI: <b>${resultData.ROI}%</b></div>
            <div>BEP (í‰ê· ): <b>ì•½ ${resultData.BEP.toLocaleString('ko-KR')}ë§¤ íŒë§¤ í•„ìš”</b></div>
            <hr style="border:0; border-top:1px solid var(--border-color); margin: 12px 0;">
            <div>íˆ¬ìì ì˜ˆìƒ ìˆ˜ìµ: <b>${formatToKrwManwon(resultData.investorProfit)}</b> (${resultData.investorShare}%)</div>
            <div>ì‚¬ì—…ì£¼ì²´ ì˜ˆìƒ ìˆ˜ìµ: <b>${formatToKrwManwon(resultData.ownerProfit)}</b> (${100 - resultData.investorShare}%)</div>
        `;
        runSimulation();
        updateBepTable(resultData.totalCost, resultData.ticketDetails);
        resultDiv.classList.add('visible');
    };

    // --- Advanced Analytics ---
    const salesRateSlider = document.getElementById('salesRateSlider');
    const salesRateLabel = document.getElementById('salesRateLabel');
    const simulationResultDiv = document.getElementById('simulationResult');
    const bepTable = document.getElementById('bepTable');

    const runSimulation = () => {
        const salesRate = parseInt(salesRateSlider.value);
        salesRateLabel.textContent = `${salesRate}%`;
        const resultData = calculate(salesRate);
        const formatToKrwManwon = (amount) => `KRW ${(amount / 10000).toLocaleString('ko-KR', { maximumFractionDigits: 0 })} ë§Œì›`;
        simulationResultDiv.innerHTML = `íŒë§¤ìœ¨ ${salesRate}% ì ìš© ì‹œ, ì˜ˆìƒ ìˆœìˆ˜ìµ: <b>${formatToKrwManwon(resultData.netProfit)}</b>, ROI: <b>${resultData.ROI}%</b>`;
    };

    const updateBepTable = (totalCost, ticketDetails) => {
        let tableHTML = '<thead><tr><th>í‹°ì¼“ ë“±ê¸‰</th><th>ë‹¨ê°€ (ë§Œì›)</th><th>BEP ë‹¬ì„± íŒë§¤ëŸ‰</th></tr></thead><tbody>';
        if (ticketDetails.length === 0) {
            tableHTML += '<tr><td colspan="3">í‹°ì¼“ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</td></tr>';
        } else {
            ticketDetails.forEach(ticket => {
                const bepForTicket = ticket.price > 0 ? Math.ceil((totalCost / 10000) / ticket.price) : 'N/A';
                tableHTML += `<tr><td>${ticket.type}</td><td>${ticket.price.toLocaleString('en-US')}</td><td>${bepForTicket.toLocaleString('en-US')} ë§¤</td></tr>`;
            });
        }
        tableHTML += '</tbody>';
        bepTable.innerHTML = tableHTML;
    };

    salesRateSlider.addEventListener('input', runSimulation);

     // --- Gemini API Integration ---
    const callGemini = async (prompt) => {
        const apiKey = ""; // API í‚¤ëŠ” ë¹„ì›Œë‘ì„¸ìš”.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            }
            return "AIë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        } catch (error) {
            console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:", error);
            return "AI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
    };

    document.getElementById('generateOverviewBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = 'ìƒì„± ì¤‘...';
        btn.disabled = true;

        const projectName = mainForm.elements.projectName.value || 'ë¯¸ì •';
        const artist = mainForm.elements.artist.value || 'ë¯¸ì •';
        
        const prompt = `ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì—”í„°í…Œì¸ë¨¼íŠ¸ íˆ¬ììì—ê²Œ ë§¤ë ¥ì ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆëŠ” 'í”„ë¡œì íŠ¸ ê°œìš”'ì™€ 'íŠ¹ì´ì‚¬í•­ ë° ê¸°ëŒ€íš¨ê³¼'ë¥¼ ê°ê° 2-3ë¬¸ì¥ì˜ ì „ë¬¸ê°€ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. ê²°ê³¼ëŠ” ì•„ë˜ í˜•ì‹ì„ ë°˜ë“œì‹œ ì§€ì¼œì„œ êµ¬ë¶„í•´ì¤˜:

[ê°œìš”]
(ì—¬ê¸°ì— í”„ë¡œì íŠ¸ ê°œìš” ì‘ì„±)

[íŠ¹ì´ì‚¬í•­]
(ì—¬ê¸°ì— íŠ¹ì´ì‚¬í•­ ë° ê¸°ëŒ€íš¨ê³¼ ì‘ì„±)

---
- ì‚¬ì—…ëª…: ${projectName}
- ì•„í‹°ìŠ¤íŠ¸: ${artist}
`;
        const responseText = await callGemini(prompt);
        
        const overviewMatch = responseText.match(/\[ê°œìš”\]\s*([\s\S]*?)\s*\[íŠ¹ì´ì‚¬í•­\]/);
        const notesMatch = responseText.match(/\[íŠ¹ì´ì‚¬í•­\]\s*([\s\S]*)/);

        if (overviewMatch && overviewMatch[1]) {
            mainForm.elements.projectOverview.value = overviewMatch[1].trim();
        }
        if (notesMatch && notesMatch[1]) {
            mainForm.elements.specialNotes.value = notesMatch[1].trim();
        }

        btn.textContent = 'âœ¨ AIë¡œ ê°œìš” ìë™ ì‘ì„±';
        btn.disabled = false;
        saveData(); // Save generated text
    });

    document.getElementById('analyzeRiskBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = 'ë¶„ì„ ì¤‘...';
        btn.disabled = true;
        const riskResultDiv = document.getElementById('riskAnalysisResult');
        riskResultDiv.textContent = 'AIê°€ ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

        const resultData = calculate();
        const ticketInfo = resultData.ticketDetails.map(t => `${t.type}: ${t.count}ì„ x ${t.price}ë§Œì›`).join(', ');

        const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ì—”í„°í…Œì¸ë¨¼íŠ¸ íˆ¬ì ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì•„ë˜ì˜ ê³µì—° íˆ¬ì ì œì•ˆì„œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ë°œìƒí•  ìˆ˜ ìˆëŠ” ì ì¬ì  ë¦¬ìŠ¤í¬ 3ê°€ì§€ì™€ ê·¸ì— ëŒ€í•œ ì™„í™” ë°©ì•ˆì„ ì „ë¬¸ê°€ì˜ ê´€ì ì—ì„œ ë¶„ì„í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ”ç®‡æ¡æ›¸ã(bullet points) í˜•ì‹ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì œì‹œí•´ì£¼ì„¸ìš”.

- ì‚¬ì—…ëª…: ${mainForm.elements.projectName.value}
- ì•„í‹°ìŠ¤íŠ¸: ${mainForm.elements.artist.value}
- ì´ ë¹„ìš©: ${ (resultData.totalCost / 10000).toLocaleString() }ë§Œì›
- ì˜ˆìƒ ì´ ìˆ˜ìµ: ${ (resultData.totalRevenue / 10000).toLocaleString() }ë§Œì›
- í‹°ì¼“ ì •ë³´: ${ticketInfo}
- ìˆœìˆ˜ìµ: ${ (resultData.netProfit / 10000).toLocaleString() }ë§Œì›
`;
        const analysis = await callGemini(prompt);
        riskResultDiv.textContent = analysis;

        btn.textContent = 'âœ¨ AIë¡œ ë¦¬ìŠ¤í¬ ë¶„ì„í•˜ê¸°';
        btn.disabled = false;
    });

    document.getElementById('generateCostItemsBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = 'ì¶”ì²œ ì¤‘...';
        btn.disabled = true;
        const prompt = `ì—”í„°í…Œì¸ë¨¼íŠ¸ ì½˜ì„œíŠ¸ë‚˜ íŒ¬ë¯¸íŒ…ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì£¼ìš” ë¹„ìš© í•­ëª© 5ê°€ì§€ë¥¼ ë¦¬ìŠ¤íŠ¸ì—…í•´ì¤˜. ì•„í‹°ìŠ¤íŠ¸ ê°œëŸ°í‹°ì™€ ë² ë‰´ ë¹„ìš©ì€ ì´ë¯¸ ìˆìœ¼ë‹ˆ ì œì™¸í•˜ê³ , "í•­ëª©ëª…" í˜•ì‹ìœ¼ë¡œ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ í•œ ì¤„ë¡œë§Œ ë‹µë³€í•´ì¤˜. ì˜ˆ: ë¬´ëŒ€ ì œì‘ë¹„,ìŒí–¥/ì¡°ëª… ì¥ë¹„ ë Œíƒˆ,ê²½í˜¸ ë° ì•ˆì „,í™ë³´ ë§ˆì¼€íŒ…,ìŠ¤íƒœí”„ ì¸ê±´ë¹„`;
        const response = await callGemini(prompt);
        response.split(',').forEach(item => {
            if (item.trim()) {
                addListItem(document.getElementById('costList'), 'ê¸°íƒ€ ë¹„ìš©', 'costname', 'ê¸ˆì•¡', 'costval', item.trim());
            }
        });
        btn.textContent = 'âœ¨ AI ì˜ˆìƒ ë¹„ìš© ì¶”ì²œ';
        btn.disabled = false;
        saveData();
    });

    document.getElementById('generateRevenueItemsBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = 'ì¶”ì²œ ì¤‘...';
        btn.disabled = true;
        const prompt = `ì—”í„°í…Œì¸ë¨¼íŠ¸ ì½˜ì„œíŠ¸ë‚˜ íŒ¬ë¯¸íŒ…ì—ì„œ í‹°ì¼“ íŒë§¤ ì™¸ì— ë°œìƒí•  ìˆ˜ ìˆëŠ” ì¶”ê°€ ìˆ˜ìµì› ì•„ì´ë””ì–´ 3ê°€ì§€ë¥¼ ë¦¬ìŠ¤íŠ¸ì—…í•´ì¤˜. "í•­ëª©ëª…" í˜•ì‹ìœ¼ë¡œ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ì„œ í•œ ì¤„ë¡œë§Œ ë‹µë³€í•´ì¤˜. ì˜ˆ: ê³µì‹ MD ìƒí’ˆ íŒë§¤,ì˜¨ë¼ì¸ ìŠ¤íŠ¸ë¦¬ë° ìœ ë£Œ ì¤‘ê³„,í˜„ì¥ ê´‘ê³  ë° ìŠ¤í°ì„œì‹­`;
        const response = await callGemini(prompt);
        response.split(',').forEach(item => {
            if (item.trim()) {
                addListItem(document.getElementById('revList'), 'ê¸°íƒ€ ìˆ˜ìµ', 'revname', 'ê¸ˆì•¡', 'revval', item.trim());
            }
        });
        btn.textContent = 'âœ¨ AI ì¶”ê°€ ìˆ˜ìµì› ì¶”ì²œ';
        btn.disabled = false;
        saveData();
    });

    document.getElementById('generateSummaryBtn').addEventListener('click', async function() {
        const btn = this;
        btn.textContent = 'ìƒì„± ì¤‘...';
        btn.disabled = true;
        const summaryP = document.getElementById('aiSummary');
        summaryP.textContent = 'AIê°€ ì œì•ˆì„œë¥¼ ìš”ì•½í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

        const resultData = calculate();
        const prompt = `ì•„ë˜ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì¢…í•©í•˜ì—¬, íˆ¬ììì—ê²Œ ë³´ë‚´ëŠ” íˆ¬ì ì œì•ˆì„œì˜ í•µì‹¬ ìš”ì•½(Executive Summary)ì„ 3~4ë¬¸ì¥ì˜ ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì¤˜. í”„ë¡œì íŠ¸ì˜ ë§¤ë ¥ê³¼ ë†’ì€ ìˆ˜ìµì„±ì„ ê°•ì¡°í•´ì¤˜.

- í”„ë¡œì íŠ¸ëª…: ${mainForm.elements.projectName.value}
- ì•„í‹°ìŠ¤íŠ¸: ${mainForm.elements.artist.value}
- í”„ë¡œì íŠ¸ ê°œìš”: ${mainForm.elements.projectOverview.value}
- ì´ íˆ¬ì ìš”ì²­ ê¸ˆì•¡: ${mainForm.elements.requestAmount.value}ë§Œì›
- ì˜ˆìƒ ì´ ìˆ˜ìµ: ${(resultData.totalRevenue / 10000).toLocaleString()}ë§Œì›
- ì˜ˆìƒ ìˆœìˆ˜ìµ: ${(resultData.netProfit / 10000).toLocaleString()}ë§Œì›
- ì˜ˆìƒ ROI: ${resultData.ROI}%
`;
        const summary = await callGemini(prompt);
        summaryP.textContent = summary;
        btn.textContent = 'âœ¨ AIë¡œ ìš”ì•½ ìƒì„±í•˜ê¸°';
        btn.disabled = false;
    });


    // --- Init & Event Listeners ---
    const init = () => {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            loadData(JSON.parse(savedData));
        } else {
            addListItem(document.getElementById('costList'), 'ê¸°íƒ€ ë¹„ìš©', 'costname', 'ê¸ˆì•¡', 'costval');
            addListItem(document.getElementById('revList'), 'ê¸°íƒ€ ìˆ˜ìµ', 'revname', 'ê¸ˆì•¡', 'revval');
            addTicketItem();
        }
    };
    init();

    mainForm.addEventListener('input', saveData);
    document.getElementById('addCostBtn').addEventListener('click', () => { addListItem(document.getElementById('costList'), 'ê¸°íƒ€ ë¹„ìš©', 'costname', 'ê¸ˆì•¡', 'costval'); saveData(); });
    document.getElementById('addRevBtn').addEventListener('click', () => { addListItem(document.getElementById('revList'), 'ê¸°íƒ€ ìˆ˜ìµ', 'revname', 'ê¸ˆì•¡', 'revval'); saveData(); });
    document.getElementById('addTicketBtn').addEventListener('click', () => { addTicketItem(); saveData(); });
    document.getElementById('savePdfBtn').addEventListener('click', async () => {
        const btn = document.getElementById('savePdfBtn');
        btn.innerText = "PDF ìƒì„±ì¤‘...";
        btn.disabled = true;
        
        const card = document.getElementById('main-card');
        card.classList.add('pdf-export-mode');

        displayFinalResults();

        try {
            await new Promise(resolve => setTimeout(resolve, 100));

            const pdfContent = document.getElementById('pdf-content');
            const canvas = await html2canvas(pdfContent, { 
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true
            });

            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            const projectName = document.querySelector('input[name="projectName"]').value || 'íˆ¬ìì œì•ˆì„œ';
            pdf.save(`${projectName}.pdf`);
        } catch (error) {
            console.error("PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("PDFë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } finally {
            card.classList.remove('pdf-export-mode');
            btn.innerText = "PDFë¡œ ì €ì¥";
            btn.disabled = false;
        }
    });
    
    const submitBtn = document.getElementById('submitBtn');
    const submissionSuccessScreen = document.getElementById('submission-success');
    const submissionMessage = document.getElementById('submission-message');
    const startNewBtn = document.getElementById('startNewBtn');
    const progressBar = document.querySelector('.progress-bar');

    submitBtn.addEventListener('click', () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');

        const timestamp = `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        submissionMessage.textContent = `ì•½ì‹ íˆ¬ìì œì•ˆì„œëŠ”, ${timestamp}ì— ì •ìƒì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.`;

        mainForm.style.display = 'none';
        progressBar.style.display = 'none';
        submissionSuccessScreen.style.display = 'block';
    });

    startNewBtn.addEventListener('click', () => {
        localStorage.removeItem(STORAGE_KEY);
        window.location.reload();
    });

    [document.getElementById('costList'), document.getElementById('revList'), document.getElementById('ticketList')].forEach(list => {
        list.addEventListener('click', function(e) {
            if (e.target.classList.contains('del-btn')) {
                e.target.parentElement.remove();
                saveData();
            }
        });
    });
});
</script>
</body>
</html>
